<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - public/scripts/maintenance_scripts/taxcounts_metadata_utils_hdf5.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>public/scripts/maintenance_scripts/taxcounts_metadata_utils_hdf5.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">61.42</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">539</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">55.26</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">5.30</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">//#!/usr/bin/env node

var args = process.argv.slice(2);

var dbhost = args[0];
var pid = args[1];
var json_dir= &#039;../../json&#039;;
var mysql = require(&#039;mysql2&#039;);
var path = require(&#039;path&#039;);
//var h5 = require(&#039;hdf5&#039;)
var hdf5 = require(&#039;hdf5&#039;).hdf5;
var async = require(&#039;async&#039;)
NODE_DATABASE = &#039;vamps_development&#039;
var db_config = {
  host     : dbhost,
  user     : &#039;ruby&#039;,
  password : &#039;ruby&#039;,
  database :  NODE_DATABASE
};
var conn = mysql.createConnection({
  host     : db_config.host,
  user     : db_config.user,
  password : db_config.password,
  database : db_config.database
});

//var db = conn.connect();


var query_core = &quot; FROM sequence_pdr_info&quot; 
query_core += &quot; JOIN sequence_uniq_info USING(sequence_id)&quot;
query_core += &quot; JOIN silva_taxonomy_info_per_seq USING(silva_taxonomy_info_per_seq_id)&quot;
query_core += &quot; JOIN silva_taxonomy USING(silva_taxonomy_id)&quot; 

var domain_query1 = &quot;SELECT sum(seq_count) as knt, dataset_id, domain_id&quot;
domain_query1 += query_core
domain_query1 += &quot; WHERE dataset_id in&quot;
var domain_query2 = &quot; GROUP BY dataset_id, domain_id&quot;

var phylum_query1 = &quot;SELECT sum(seq_count) as knt, dataset_id, domain_id, phylum_id&quot; 
phylum_query1 += query_core
phylum_query1 += &quot; WHERE dataset_id in&quot;
var phylum_query2 = &quot; GROUP BY dataset_id, domain_id, phylum_id&quot;

var class_query1 = &quot;SELECT sum(seq_count) as knt, dataset_id, domain_id, phylum_id, klass_id&quot; 
class_query1 += query_core
class_query1 += &quot; WHERE dataset_id in&quot;
var class_query2 = &quot; GROUP BY dataset_id, domain_id, phylum_id, klass_id&quot;

var order_query1 = &quot;SELECT sum(seq_count) as knt, dataset_id, domain_id, phylum_id, klass_id, order_id&quot;
order_query1 += query_core
order_query1 += &quot; WHERE dataset_id in&quot;
var order_query2 = &quot; GROUP BY dataset_id, domain_id, phylum_id, klass_id, order_id&quot;

var family_query1 = &quot;SELECT sum(seq_count) as knt, dataset_id, domain_id, phylum_id, klass_id, order_id, family_id&quot;
family_query1 += query_core
family_query1 += &quot; WHERE dataset_id in&quot;
var family_query2 = &quot; GROUP BY dataset_id, domain_id, phylum_id, klass_id, order_id, family_id&quot;

var genus_query1 = &quot;SELECT sum(seq_count) as knt, dataset_id, domain_id, phylum_id, klass_id, order_id, family_id, genus_id&quot; 
genus_query1 += query_core
genus_query1 += &quot; WHERE dataset_id in&quot;
var genus_query2 = &quot; GROUP BY dataset_id, domain_id, phylum_id, klass_id, order_id, family_id, genus_id&quot;

var species_query1 = &quot;SELECT sum(seq_count) as knt, dataset_id, domain_id, phylum_id, klass_id, order_id, family_id, genus_id, species_id&quot; 
species_query1 += query_core
species_query1 += &quot; WHERE dataset_id in&quot;
var species_query2 = &quot; GROUP BY dataset_id, domain_id, phylum_id, klass_id, order_id, family_id, genus_id, species_id&quot;

var strain_query1 = &quot;SELECT sum(seq_count) as knt, dataset_id, domain_id, phylum_id, klass_id, order_id, family_id, genus_id, species_id, strain_id&quot; 
strain_query1 += query_core
strain_query1 += &quot; WHERE dataset_id in&quot;
var strain_query2 = &quot; GROUP BY dataset_id, domain_id, phylum_id, klass_id, order_id, family_id, genus_id, species_id, strain_id&quot;
var queries = [{&quot;rank&quot;:&quot;domain&quot;,&quot;query1&quot;:domain_query1,&quot;query2&quot;:domain_query2},
           {&quot;rank&quot;:&quot;phylum&quot;,&quot;query1&quot;:phylum_query1,&quot;query2&quot;:phylum_query2},
           {&quot;rank&quot;:&quot;klass&quot;,&quot;query1&quot;:class_query1,&quot;query2&quot;:class_query2},
           {&quot;rank&quot;:&quot;order&quot;,&quot;query1&quot;:order_query1,&quot;query2&quot;:order_query2},
           {&quot;rank&quot;:&quot;family&quot;,&quot;query1&quot;:family_query1,&quot;query2&quot;:family_query2},
           {&quot;rank&quot;:&quot;genus&quot;,&quot;query1&quot;:genus_query1,&quot;query2&quot;:genus_query2},
           {&quot;rank&quot;:&quot;species&quot;,&quot;query1&quot;:species_query1,&quot;query2&quot;:species_query2},
           {&quot;rank&quot;:&quot;strain&quot;,&quot;query1&quot;:strain_query1,&quot;query2&quot;:strain_query2}
           ]
str_ids = [&#039;domain_id&#039;, &#039;phylum_id&#039;, &#039;klass_id&#039;, &#039;order_id&#039;, &#039;family_id&#039;, &#039;genus_id&#039;, &#039;species_id&#039;, &#039;strain_id&#039;];
required_metadata_fields = [ &quot;altitude&quot;, &quot;assigned_from_geo&quot;, &quot;collection_date&quot;, &quot;depth&quot;, &quot;country&quot;, &quot;elevation&quot;, &quot;env_biome&quot;, &quot;env_feature&quot;, &quot;env_matter&quot;, &quot;latitude&quot;, &quot;longitude&quot;, &quot;public&quot;];

//ids = get_dataset_ids(conn, pid) 
//console.log(&#039;ids&#039;,ids)
q0 = &quot;SELECT dataset_id,project_id from dataset where project_id=&#039;&quot;+pid+&quot;&#039;&quot; 
console.log(q0)
var ids = {}
ids.dids=[]
ids.pids={}
counts_lookup = {}
metadata_lookup = {}
    //console.log(ids)
async.waterfall(
    [
        
        function(callback){
            q0 = &quot;SELECT dataset_id,project_id from dataset where project_id=&#039;&quot;+pid+&quot;&#039;&quot; 
            conn.query(q0, function(err, rows, fields){
                if(err){
                    console.log(err)
                }else{
                    for(r in rows){
                        //console.log(&#039;row&#039;,rows[r])
                        ids.dids.push(rows[r].dataset_id)
                        ids.pids[rows[r].project_id]=1
                        //pids[row[1]]=1
                    }
                    callback(null, ids)
                }
            });
        },
// domain
        function(dsrows, callback){
            console.log(dsrows)
            sql = queries[0].query1+&quot;(&#039;&quot;+dsrows.dids.join(&quot;&#039;,&#039;&quot;)+&quot;&#039;)&quot;+queries[0][&quot;query2&quot;]
            console.log(sql)
            conn.query(sql, function(err, rows, fields){
                if(err){
                    console.log(err)
                }else{
                    
                    for(n in rows){
                        //console.log(rows[n])
                        count = parseInt(rows[n].knt)
                        did = rows[n].dataset_id;
                        tax_id_lst = []
                        str = &#039;&#039;
                        for( k=0; k&lt;1; k++ ){
                            tax_id_lst.push(rows[k][str_ids[k]])
                            str += &#039; &#039;+str_ids[k]
                        }
                        //console.log(tax_id_str)
                        //console.log(str)
                    
                        tmp = tax_id_lst.join(&#039;_&#039;)
                        if(counts_lookup.hasOwnProperty(did)){
                            counts_lookup[did][tmp]=count
                        }else{
                            counts_lookup[did] = {}
                            counts_lookup[did][tmp]=count
                        }
                        
                    }
                    //console.log(counts_lookup)
                    callback(null, dsrows)
                }
            });
        },

        function(dsrows,callback){
            sql = queries[1].query1+&quot;(&#039;&quot;+ids.dids.join(&quot;&#039;,&#039;&quot;)+&quot;&#039;)&quot;+queries[1][&quot;query2&quot;]
            console.log(sql)
            conn.query(sql, function(err, rows, fields){
                if(err){
                    console.log(err)
                }else{
                    for(n in rows){
                        //console.log(rows[n])
                        count = parseInt(rows[n].knt)
                        did = rows[n].dataset_id;
                        tax_id_lst = []
                        str = &#039;&#039;
                        for( k=0; k&lt;2; k++ ){
                            tax_id_lst.push(rows[k][str_ids[k]])
                            str += &#039; &#039;+str_ids[k]
                        }
                        //console.log(tax_id_str)
                        //console.log(str)
                    
                        tmp = tax_id_lst.join(&#039;_&#039;)
                        if(counts_lookup.hasOwnProperty(did)){
                            counts_lookup[did][tmp]=count
                        }else{
                            counts_lookup[did] = {}
                            counts_lookup[did][tmp]=count
                        }
                        
                    }
                    //console.log(counts_lookup)
                    callback(null, dsrows)
                }
            });
        },

        function(dsrows,callback){
            sql = queries[2].query1+&quot;(&#039;&quot;+ids.dids.join(&quot;&#039;,&#039;&quot;)+&quot;&#039;)&quot;+queries[2][&quot;query2&quot;]
            console.log(sql)
            conn.query(sql, function(err, rows, fields){
                if(err){
                    console.log(err)
                }else{
                    for(n in rows){
                        //console.log(rows[n])
                        count = parseInt(rows[n].knt)
                        did = rows[n].dataset_id;
                        tax_id_lst = []
                        str = &#039;&#039;
                        for( k=0; k&lt;3; k++ ){
                            tax_id_lst.push(rows[k][str_ids[k]])
                            str += &#039; &#039;+str_ids[k]
                        }
                        //console.log(tax_id_str)
                        //console.log(str)
                    
                        tmp = tax_id_lst.join(&#039;_&#039;)
                        if(counts_lookup.hasOwnProperty(did)){
                            counts_lookup[did][tmp]=count
                        }else{
                            counts_lookup[did] = {}
                            counts_lookup[did][tmp]=count
                        }
                        
                    }
                    //console.log(counts_lookup)
                    callback(null, dsrows)
                }
            });
        },

        function(dsrows,callback){
            sql = queries[3].query1+&quot;(&#039;&quot;+ids.dids.join(&quot;&#039;,&#039;&quot;)+&quot;&#039;)&quot;+queries[3][&quot;query2&quot;]
            console.log(sql)
            conn.query(sql, function(err, rows, fields){
                if(err){
                    console.log(err)
                }else{
                    for(n in rows){
                        //console.log(rows[n])
                        count = parseInt(rows[n].knt)
                        did = rows[n].dataset_id;
                        tax_id_lst = []
                        str = &#039;&#039;
                        for( k=0; k&lt;4; k++ ){
                            tax_id_lst.push(rows[k][str_ids[k]])
                            str += &#039; &#039;+str_ids[k]
                        }
                        //console.log(tax_id_str)
                        //console.log(str)
                    
                        tmp = tax_id_lst.join(&#039;_&#039;)
                        if(counts_lookup.hasOwnProperty(did)){
                            counts_lookup[did][tmp]=count
                        }else{
                            counts_lookup[did] = {}
                            counts_lookup[did][tmp]=count
                        }
                        
                    }
                    //console.log(counts_lookup)
                    callback(null, dsrows)
                }
            });
        },

        function(dsrows,callback){
            sql = queries[4].query1+&quot;(&#039;&quot;+ids.dids.join(&quot;&#039;,&#039;&quot;)+&quot;&#039;)&quot;+queries[4][&quot;query2&quot;]
            console.log(sql)
            conn.query(sql, function(err, rows, fields){
                if(err){
                    console.log(err)
                }else{
                    for(n in rows){
                        //console.log(rows[n])
                        count = parseInt(rows[n].knt)
                        did = rows[n].dataset_id;
                        tax_id_lst = []
                        str = &#039;&#039;
                        for( k=0; k&lt;5; k++ ){
                            tax_id_lst.push(rows[k][str_ids[k]])
                            str += &#039; &#039;+str_ids[k]
                        }
                        //console.log(tax_id_str)
                        //console.log(str)
                    
                        tmp = tax_id_lst.join(&#039;_&#039;)
                        if(counts_lookup.hasOwnProperty(did)){
                            counts_lookup[did][tmp]=count
                        }else{
                            counts_lookup[did] = {}
                            counts_lookup[did][tmp]=count
                        }
                        
                    }
                    //console.log(counts_lookup)
                    callback(null, dsrows)
                }
            });
        },

        function(dsrows,callback){
            sql = queries[5].query1+&quot;(&#039;&quot;+ids.dids.join(&quot;&#039;,&#039;&quot;)+&quot;&#039;)&quot;+queries[5][&quot;query2&quot;]
            console.log(sql)
            conn.query(sql, function(err, rows, fields){
                if(err){
                    console.log(err)
                }else{
                    for(n in rows){
                        //console.log(rows[n])
                        count = parseInt(rows[n].knt)
                        did = rows[n].dataset_id;
                        tax_id_lst = []
                        str = &#039;&#039;
                        for( k=0; k&lt;6; k++ ){
                            tax_id_lst.push(rows[k][str_ids[k]])
                            str += &#039; &#039;+str_ids[k]
                        }
                        //console.log(tax_id_str)
                        //console.log(str)
                    
                        tmp = tax_id_lst.join(&#039;_&#039;)
                        if(counts_lookup.hasOwnProperty(did)){
                            counts_lookup[did][tmp]=count
                        }else{
                            counts_lookup[did] = {}
                            counts_lookup[did][tmp]=count
                        }
                        
                    }
                    //console.log(counts_lookup)
                    callback(null, dsrows)
                }
            });
        },

        function(dsrows,callback){
            sql = queries[6].query1+&quot;(&#039;&quot;+ids.dids.join(&quot;&#039;,&#039;&quot;)+&quot;&#039;)&quot;+queries[6][&quot;query2&quot;]
            console.log(sql)
            conn.query(sql, function(err, rows, fields){
                if(err){
                    console.log(err)
                }else{
                    for(n in rows){
                        //console.log(rows[n])
                        count = parseInt(rows[n].knt)
                        did = rows[n].dataset_id;
                        tax_id_lst = []
                        str = &#039;&#039;
                        for( k=0; k&lt;7; k++ ){
                            tax_id_lst.push(rows[k][str_ids[k]])
                            str += &#039; &#039;+str_ids[k]
                        }
                        //console.log(tax_id_str)
                        //.log(str)
                    
                        tmp = tax_id_lst.join(&#039;_&#039;)
                        if(counts_lookup.hasOwnProperty(did)){
                            counts_lookup[did][tmp]=count
                        }else{
                            counts_lookup[did] = {}
                            counts_lookup[did][tmp]=count
                        }
                        
                    }
                    console.log(&#039;counts_lookup&#039;,counts_lookup)
                    callback(null, dsrows)
                }
            });
        },


        REQUIRED_METADATA,
        CUSTOM_METADATA,

    ],
    function(err, status, rows) {
        conn.end();
        file_path = path.join(json_dir,NODE_DATABASE+&#039;--hdf5NEW.h5&#039;)
        //console.log(&#039;metadata_lookup&#039;,metadata_lookup)
        var Access = require(&#039;../../../node_modules/hdf5/lib/globals&#039;).Access;
        //console.log(Access)
        var hdf5 = require(&#039;hdf5&#039;).hdf5;
        var f      = new hdf5.File(file_path, Access.ACC_TRUNC);
        //f = hdf5.File(file_path, &quot;w&quot;)
        //dt = hdf5.special_dtype(vlen=str)
        for(did in counts_lookup){
            //console.log(did)
            didgrp = f.createGroup(did)
            subgrp1 = f.createGroup(did+&quot;/taxcounts&quot;)
            subgrp2 = f.createGroup(did+&quot;/metadata&quot;)

            for(i in counts_lookup[did]){
                // console.log(i,counts_lookup[did][i])
                //#print i.strip(&#039;_&#039;), counts_lookup[did][i]
                //#subgrp1.create_dataset(i.strip(&#039;_&#039;), counts_lookup[did][i], dtype=&#039;i&#039;)
                //#f[did+&quot;/taxcounts/&quot;+i.strip(&#039;_&#039;)] = counts_lookup[did][i]
                //subgrp1[i] = counts_lookup[did][i]
            }  
            subgrp1.flush(); 
            if(did in metadata_lookup){
                for(mdname in metadata_lookup[did]){
                    //#print mdname,metadata_lookup[did][mdname]
                    //console.log(mdname,metadata_lookup[did][mdname])
                    if(metadata_lookup[did].hasOwnProperty(mdname)){
                        console.log(&#039;got it&#039;,did,mdname,metadata_lookup[did][mdname])
                        val = metadata_lookup[did][mdname]
                        //x = numpy.string_(metadata_lookup[did][i], dtype=dt)
                        //#x = &quot;{:10}&quot;.format(metadata_lookup[did][i])
                        //print len(x),x
                        //subgrp2.attrs[i] = x
                        //#subgrp2.attrs[i] = metadata_lookup[did][i]
                        //#dset.attrs[&#039;temperature&#039;] = 99.5
                        //#f[did+&quot;/metadata/&quot;+i] = metadata_lookup[did][i]
                        //#subgrp2.create_dataset(i, metadata_lookup[did][i], dtype=&#039;S10&#039;)
                        if(val){
                            subgrp2[mdname] = val;
                        }   
                        
                    }
                    
                }
                

            }
            subgrp2.flush()
            
        }
        f.close() 

        console.log(&#039;Finished writing&#039;, file_path)
        console.log(status);
    }
);
////////////////////////////////////////
function RANK_SELECT(dsrows,rank_num,callback){
            console.log(&#039;dsrows1&#039;,dsrows)
            sql = queries[7].query1+&quot;(&#039;&quot;+ids.dids.join(&quot;&#039;,&#039;&quot;)+&quot;&#039;)&quot;+queries[7][&quot;query2&quot;]
            console.log(sql)
            conn.query(sql, function(err, rows, fields){
                if(err){
                    console.log(err)
                }else{
                    for(n in rows){
                        //console.log(rows[n])
                        count = parseInt(rows[n].knt)
                        did = rows[n].dataset_id;
                        tax_id_lst = []
                        str = &#039;&#039;
                        for( k=0; k&lt;8; k++ ){
                            tax_id_lst.push(rows[k][str_ids[k]])
                            str += &#039; &#039;+str_ids[k]
                        }
                        //console.log(tax_id_str)
                        //console.log(str)
                    
                        tmp = tax_id_lst.join(&#039;_&#039;)
                        if(counts_lookup.hasOwnProperty(did)){
                            counts_lookup[did][tmp]=count
                        }else{
                            counts_lookup[did] = {}
                            counts_lookup[did][tmp]=count
                        }
                        
                    }
                    //console.log(counts_lookup)
                    callback(null, dsrows)
                }
            });
}         
 // custom metadata
function CUSTOM_METADATA(dsrows,callback){
            console.log(&#039;dsrows2&#039;,dsrows)
            pids = Object.keys(ids.pids)
            for(p in pids){
                //console.log(pids[p])
                custom_table = &#039;custom_metadata_&#039;+ pids[p]
                cust_metadata_lookup = {}
                field_collection = [&#039;dataset_id&#039;]
                sql1 = &quot;SELECT project_id,field_name from custom_metadata_fields WHERE project_id = &#039;&quot;+pids[p]+&quot;&#039;&quot;
                conn.query(sql1, function(err, rows, fields){
                    if(err){
                        console.log(err)
                    }else{
                        for(n in rows){
                            pid = rows[n].project_id
                            field = rows[n].field_name
                            if(field != &#039;dataset_id&#039;){
                                field_collection.push(field)
                            }
                        }
                        cust_dquery = &quot;SELECT `&quot; + field_collection.join(&#039;`,`&#039;)+ &quot;` from &quot; + custom_table
                        //console.log(cust_dquery)
                        conn.query(cust_dquery, function(err, rows, fields){
                            if(err){
                                console.log(err)
                            }else{
                                for(n in rows){
                                    did = rows[n].dataset_id
                                    for(i in field_collection){
                                        name = field_collection[i]
                                        value = rows[n][name]
                                        //console.log(name,value)
                                        if(metadata_lookup.hasOwnProperty(did)){
                                             metadata_lookup[did][name] = value
                                        }else{
                                             metadata_lookup[did] = {}
                                             metadata_lookup[did][name] = value
                                        }
                                    }
                                }
                                //console.log(metadata_lookup)
                                callback(null, &#039;FINISHED&#039;,dsrows)
                            }
                        })
                        
                    }
                });

            }

           
}
// req metadata
function REQUIRED_METADATA(dsrows,callback){
            sql = &quot;SELECT dataset_id, &quot;+required_metadata_fields.join(&#039;,&#039;)+&quot; from required_metadata_info WHERE dataset_id in (&#039;&quot;+ids.dids.join(&quot;&#039;,&#039;&quot;)+&quot;&#039;)&quot;
            console.log(&#039;dsrows3&#039;,dsrows)
            conn.query(sql, function(err, rows, fields){
                if(err){
                    console.log(err)
                }else{
                    for(n in rows){
                        did = rows[n].dataset_id
                        for(i in required_metadata_fields){
                            name = required_metadata_fields[i]
                            value = rows[n][name]
                            //console.log(name,value)
                            if(metadata_lookup.hasOwnProperty(did)){
                                 metadata_lookup[did][name] = value
                            }else{
                                 metadata_lookup[did] = {}
                                 metadata_lookup[did][name] = value
                            }
                        }
                    }
                    //console.log(metadata_lookup)
                    callback(null, dsrows)
                }
            });
}</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
