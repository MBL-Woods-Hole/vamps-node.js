<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - routes/helpers/custom_taxa_class.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>routes/helpers/custom_taxa_class.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">66.85</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">275</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">47.90</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">1.77</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">/*
 * TaxonomyTree = custom_taxa_class.js
 */

/*jshint multistr: true */

var constants = require(app_root + &#039;/public/constants&#039;);
var helpers = require(&#039;./helpers&#039;);
var fs = require(&#039;fs&#039;);

// Private
var taxon_name_id = 1;
var ranks = constants.RANKS;

function make_dictMap_by_rank(tags) {
  var dictMap_by_rank = {};
  // var ranks = constants.RANKS;
  ranks.forEach(function(rank) {
    dictMap_by_rank[rank] = [];
  });
  var i = null;
  for (i = 0; tags.length &gt; i; i += 1) {
    dictMap_by_rank[tags[i].rank].push(tags[i]);
  }
  return dictMap_by_rank;
}

function add_to_dict_by_key(dictMap, dictMap_key, value) 
{
  dictMap[dictMap_key] = value;
  return dictMap;
}

function get_by_key(dictMap, dictMap_key) 
{
  return dictMap[dictMap_key];
}

function make_current_dict(taxa_name, taxa_rank, i_am_a_parent, taxon_name_id, db_id)
{
  var current_dict =
  {
    parent_id: &quot;&quot;,
    children_ids : [],
    taxon: &quot;&quot;,
    rank: &quot;&quot;,
    node_id: 1,
    db_id: 1
  };
  
  current_dict.taxon = taxa_name;
  current_dict.rank = taxa_rank;
  current_dict.parent_id = i_am_a_parent;
  current_dict.node_id = taxon_name_id;
  current_dict.db_id = db_id;
  return current_dict;
}

function add_children_to_parent(dictMap_by_id, current_dict)
{
  add_to_dict_by_key(dictMap_by_id, current_dict.node_id, current_dict);
  
//  TODO: test if changed to var and removed from above
  parent_node = dictMap_by_id[current_dict.parent_id];
  if (parent_node)
  {
    parent_node.children_ids.push(current_dict.node_id);
  }
  return parent_node;
}

function check_if_rank(field_name)
{
  // ranks = [&quot;domain&quot;,&quot;phylum&quot;,&quot;klass&quot;,&quot;order&quot;,&quot;family&quot;,&quot;genus&quot;,&quot;species&quot;,&quot;strain&quot;]
  return ranks.indexOf(field_name) &gt; -1;
}

// todo: refactoring! Too long and nested
function make_taxa_tree_dict(taxonomy_obj)
{
  var taxa_tree_dict = [];
  var dictMap_by_name_n_rank = {};
  var dictMap_by_db_id_n_rank = {};
  
  var dictMap_by_id = {};
  // console.log(&quot;HHH1&quot;);
  // console.log(&quot;taxonomy_obj = &quot; + JSON.stringify(taxonomy_obj));
  // console.log(&quot;HHH&quot;);
  
  for (var i=0, len = taxonomy_obj.length; i &lt; len; i++)
  {
    in_obj = taxonomy_obj[i];
    //console.log(&quot;taxon_objs[i] = &quot; + JSON.stringify(in_obj));
    var i_am_a_parent = 0;

    for (var field_name in in_obj)
    {
      // console.log(&quot;field_name = &quot; + JSON.stringify(field_name));
      // ranks.forEach(function(rank) {
      //   dictMap_by_rank[rank] = [];
      // });
      // 
      
      var is_rank = check_if_rank(field_name);
      if (is_rank)
      {
        var db_id_field_name = field_name + &quot;_id&quot;;
        // console.log(&quot;db_id_field_name = &quot; + JSON.stringify(db_id_field_name));
        var db_id = in_obj[db_id_field_name];
        // console.log(&quot;db_id = &quot; + JSON.stringify(db_id));
      
        var parent_node = {}; 
        var current_dict = {};
        taxa_rank = field_name;
        if (in_obj.hasOwnProperty(taxa_rank))
        {
          var taxa_name = in_obj[taxa_rank];
          if (taxa_name)
          {
            node = get_by_key(dictMap_by_name_n_rank, taxa_name + &quot;_&quot; + taxa_rank);

            if (!node)
            {
              // console.log(&quot;taxa_name = &quot; + JSON.stringify(taxa_name));
              // console.log(&quot;taxa_rank = &quot; + JSON.stringify(taxa_rank));
              // console.log(&quot;i_am_a_parent = &quot; + JSON.stringify(i_am_a_parent));
              // console.log(&quot;taxon_name_id = &quot; + JSON.stringify(taxon_name_id));
            
              current_dict = make_current_dict(taxa_name, taxa_rank, i_am_a_parent, taxon_name_id, db_id);

              taxa_tree_dict.push(current_dict);
            
              add_to_dict_by_key(dictMap_by_name_n_rank,  current_dict.taxon + &quot;_&quot; + current_dict.rank, current_dict);
              add_to_dict_by_key(dictMap_by_db_id_n_rank, current_dict.db_id + &quot;_&quot; + current_dict.rank, current_dict);

              i_am_a_parent = current_dict.node_id;

              taxon_name_id += 1;
            
              add_children_to_parent(dictMap_by_id, current_dict);
            }
            else
            {
              i_am_a_parent = node.node_id;
            }
          }
        }
      }
      else
      {
        continue;
      }
    }
  }  
  return [taxa_tree_dict, dictMap_by_id, dictMap_by_db_id_n_rank, dictMap_by_name_n_rank];
}

function start_ul(level, new_level, class_name)
{
  if (level != new_level)
  {
    var html = &#039;\n&lt;ul class=&quot;&#039; + class_name + &#039;&quot;&gt;&#039;;
    // console.log(html); 
    return html;
  }
}

function end_ul(level, new_level, class_name)
{
  if (level === new_level)
  {
    var html = &#039;\n&lt;/li&gt;\n&lt;/ul&gt; &lt;!-- class=&quot;&#039; + class_name + &#039;&quot;--&gt;&#039;;
    return html;
  }
}

function clear_partial_file(fileName)
{
  fs.openSync(fileName, &quot;w&quot;);
}

function write_partial(fileName, html) 
{
  fs.appendFileSync(fileName, html);
}

function add_li(this_node)
{
  this_html = &#039;&lt;li&gt;\n&#039;;
  this_html += &#039;&lt;span class=&quot;sign&quot;&gt;&lt;i class=&quot;icon-no-sign&quot;&gt;&lt;/i&gt;&lt;/span&gt;&#039;;
  this_html += &#039;&lt;input name=&quot;custom_taxa&quot; type=&quot;checkbox&quot; id=&quot;&#039; + this_node.taxon + &#039;&quot; value=&quot;&#039; + this_node.taxon + &#039;_&#039; +this_node.rank + &#039;&quot;/&gt;\n&#039;;
  this_html += &#039;&lt;span class=&quot;open-one-layer&quot;&gt;&#039; + this_node.taxon + &#039;&lt;/span&gt;&#039;;
  return this_html;
}

function traverse(dict_map_by_id, this_node, level, fileName)
{ 
  /** todo: 
  *) benchmark what&#039;s faster: write_partial 3 times or collect html and then write_partial once above.
  */
  var new_level = 0;  
  var html = &quot;&quot;;

  html = start_ul(level, new_level, this_node.rank);
  write_partial(fileName, html);
    
  var kids_length = this_node.children_ids ? this_node.children_ids.length : 0;
  
  //console.log(&#039;this_node: &#039; + JSON.stringify(this_node));
    
  html = add_li(this_node);
  write_partial(fileName, html);
  
  for (var i=0; i &lt; kids_length; i++)
  {
//    TODO: The parameter level should not be assigned
    level += 1;
    traverse(dict_map_by_id, dict_map_by_id[this_node.children_ids[i]], level, fileName);
    level -= 1;    
  }
  new_level = level;
  html = end_ul(level, new_level, this_node.rank);
  write_partial(fileName, html);
  
}

function add_title(fileName, title)
{
  write_partial(fileName, title);
}

// Public
module.exports = TaxonomyTree;

function TaxonomyTree(rows) {
  this.taxa_tree_dict = [];
  this.taxa_tree_dict_map_by_rank = [];
  this.taxonomy_obj = rows;
  
  temp_arr = make_taxa_tree_dict(this.taxonomy_obj);
  this.taxa_tree_dict = temp_arr[0];
  this.taxa_tree_dict_map_by_id = temp_arr[1]; 
  this.taxa_tree_dict_map_by_db_id_n_rank = temp_arr[2]; 
  this.taxa_tree_dict_map_by_name_n_rank = temp_arr[3]; 
  this.taxa_tree_dict_map_by_rank = make_dictMap_by_rank(this.taxa_tree_dict);
}

TaxonomyTree.prototype.make_dict = function(tree_obj, key_name) 
{
  var i = null;
  new_dict = {};
  for (i = 0; tree_obj.length &gt; i; i += 1) {
    new_dict[tree_obj[i][key_name]] = tree_obj[i];
  }
  return new_dict;
};

TaxonomyTree.prototype.make_html_tree_file = function(dict_map_by_id, domains)
{
  var level = 1;
  var fileName = __dirname + &#039;/../../views/visuals/partials/tax_silva108_custom.html&#039;;
  
  clear_partial_file(fileName);
  var page_head = &quot;&lt;h3&gt;Silva(v108) Custom Taxonomy Selection&lt;/h3&gt;\n&lt;input type=&#039;hidden&#039; value=&#039;tax_silva108_custom&#039; name=&#039;unit_choice&#039; /&gt;\n\
  &lt;div class=&#039;radiobox&#039;&gt;\n\
		Selection Mode:\n\
    &lt;input id=&#039;clade&#039; type=&#039;radio&#039; value=&#039;clade&#039; checked=&#039;checked&#039; name=&#039;mode&#039;&gt;\n\
    Clade\n\
    &lt;input id=&#039;individual&#039; type=&#039;radio&#039; value=&#039;individual&#039; name=&#039;mode&#039;&gt;\n\
    Individual\n\
  &lt;/div&gt;\n\
  &lt;div class=&#039;tree well&#039;&gt;&quot;;
  add_title(fileName, page_head);
  
  for (var i=0; i &lt; domains.length; i++)
  {
    traverse(dict_map_by_id, domains[i], level, fileName);
  }
  write_partial(fileName, &quot;&lt;/div&gt; &lt;!-- tree well --&gt;&quot;);
  
};</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
