<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - routes/helpers/helpers.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>routes/helpers/helpers.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">60.71</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">533</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">66.30</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">6.23</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">var constants = require(app_root + &#039;/public/constants&#039;);
var express = require(&#039;express&#039;);
var router = express.Router();
var fs = require(&#039;fs&#039;);
var nodemailer = require(&#039;nodemailer&#039;);
var transporter = nodemailer.createTransport();
var queries = require(&#039;../queries&#039;);
var util = require(&#039;util&#039;);
var path  = require(&#039;path&#039;);

module.exports = {

  

  // route middleware to make sure a user is logged in
  isLoggedIn: function (req, res, next) {

      
      
      // if user is authenticated in the session, carry on
      
      if (req.isAuthenticated()) {
        console.log(&quot;Hurray! isLoggedIn.req.isAuthenticated&quot;);
        return next();
      }
      // if they aren&#039;t redirect them to the home page
      console.log(&quot;Oops! NOT isLoggedIn.req.isAuthenticated&quot;);
      // save the url in the session 
      req.session.returnTo = req.path;
      //console.log(&#039;URL Requested: &#039;+JSON.stringify(req));
      //console.log(util.inspect(req, {showHidden: false, depth: null}));
      req.flash(&#039;loginMessage&#039;, &#039;Please login or register before continuing.&#039;);
      res.redirect(&#039;/users/login&#039;);
      return;
      // res.render(&#039;user_admin/login&#039;, {
      //                 title: &#039;VAMPS: Login&#039;,                      
      //                 message      : req.flash(),
      //                 user         : req.user
      // });  // end render

  },
  
  // route middleware to make sure a user is an aministrator
  isAdmin: function (req, res, next) {

      //if user is authenticated in the session, carry on
      
      if (req.user.security_level === 1) {
        console.log(&quot;Hurray! USER is an Admin&quot;);
        return next();
      }
      // if they aren&#039;t redirect them to the home page
      console.log(&quot;Whoa! NOT an Admin&quot;);
      // save the url in the session 
      req.session.returnTo = req.path;
      //console.log(&#039;URL Requested: &#039;+JSON.stringify(req));
      //console.log(util.inspect(req, {showHidden: false, depth: null}));
      //req.flash(&#039;loginMessage&#039;, &#039;Please login or register before continuing.&#039;);
      res.redirect(&#039;/&#039;);
      return;
  }
  
};

/** Benchmarking
* Usage: 
    var helpers = require(&#039;../helpers/helpers&#039;);

    helpers.start = process.hrtime();
    some code
    helpers.elapsed_time(&quot;This is the running time for some code&quot;);
*/

module.exports.start = process.hrtime();

module.exports.elapsed_time = function(note){
    var precision = 3; // 3 decimal places
    var elapsed = process.hrtime(module.exports.start)[1] / 1000000; // divide by a million to get nano to milli
    console.log(process.hrtime(module.exports.start)[0] + &quot; s, &quot; + elapsed.toFixed(precision) + &quot; ms - &quot; + note); // print message + time
};

var ranks = constants.RANKS;

// todo: use in file instead of those in the class
module.exports.check_if_rank = function(field_name)
{
  // ranks = [&quot;domain&quot;,&quot;phylum&quot;,&quot;klass&quot;,&quot;order&quot;,&quot;family&quot;,&quot;genus&quot;,&quot;species&quot;,&quot;strain&quot;]
  return ranks.indexOf(field_name) &gt; -1;
};

module.exports.render_error_page = function(req,res,msg)
{
  req.flash(&#039;errorMessage&#039;, msg);
  res.render(&#039;error&#039;,
    { title :  &#039;Fail&#039;,	     
  	  message : req.flash(&#039;errorMessage&#039;),
      user : 	req.user.username
    });
};

module.exports.clear_file = function(fileName)
{
  fs.openSync(fileName, &quot;w&quot;);
};

module.exports.append_to_file = function(fileName, text) 
{
  fs.appendFileSync(fileName, text);
};

module.exports.write_to_file = function(fileName, text) 
{
  fs.writeFile(fileName, text, function(err){
	  if(err) { 
		  throw err;
      } else {
        
	  }
  });
};
module.exports.isInt = function(value) 
{
  return !isNaN(value) &amp;&amp; (function(x) { return (x | 0) === x; })(parseFloat(value));
};
module.exports.IsJsonString = function(str) {
    try {
        JSON.parse(str);
    } catch (e) {
        return false;
    }
    return true;
};

module.exports.onlyUnique = function(value, index, self) { 
    return self.indexOf(value) === index;
};

module.exports.mkdirSync = function (path) {
  try {
    fs.mkdirSync(path);
  } catch(e) {
    if ( e.code != &#039;EEXIST&#039; ) throw e;
  }
};

module.exports.send_mail = function(mail_info) {
  var to_addr = mail_info.addr;
  var from_addr = mail_info.from;
  var subj = mail_info.subj;
  var msg = mail_info.msg;
  transporter.sendMail(mail_info, function (error, info) {
              if (error) {
                  console.log(error);
              } else {
                  console.log(&#039;Message sent: &#039; + info.messageId);
              }
    });
	
  // transporter.sendMail({
  //         from: from_addr,
  //         to: to_addr,
  //         subject: subj,
  //         text: msg
  //       });

};
//
//
//
module.exports.run_select_datasets_query = function(rows){
    var pids         = {};
    var titles       = {};
	  var datasetsByProject = {};
    for (var i=0; i &lt; rows.length; i++) {
          var project = rows[i].project;
          var did = rows[i].did;
          var dataset = rows[i].dataset;
          var dataset_description = rows[i].dataset_description;
          var pid = rows[i].pid;
          var public = rows[i].public;
          var owner_id = rows[i].owner_user_id;
          
          PROJECT_ID_BY_DID[did]=pid;

          PROJECT_INFORMATION_BY_PID[pid] = {
            &quot;last&quot; :            rows[i].last_name,
            &quot;first&quot; :			      rows[i].first_name,
            &quot;username&quot; :		    rows[i].username,
            &quot;oid&quot; :             owner_id,
            &quot;email&quot; :			      rows[i].email,
            &quot;env_source_name&quot; : rows[i].env_source_name,
            &quot;institution&quot; :		  rows[i].institution,
            &quot;project&quot; :			    project,
    		    &quot;pid&quot; :			        pid,
            &quot;title&quot; :			      rows[i].title,
            &quot;description&quot; :	    rows[i].project_description,
            &quot;public&quot; :          rows[i].public,
          };
          if(public || rows[i].username === &#039;guest&#039;){
            PROJECT_INFORMATION_BY_PID[pid].permissions = [];  // PUBLIC
          }else{            
            PROJECT_INFORMATION_BY_PID[pid].permissions = [owner_id]; // initially has only project owner_id
          }
    	    PROJECT_INFORMATION_BY_PNAME[project] =  PROJECT_INFORMATION_BY_PID[pid];
    	  
          if(pid in DATASET_IDS_BY_PID){
            DATASET_IDS_BY_PID[pid].push(did);
          }else{
            DATASET_IDS_BY_PID[pid]=[];
            DATASET_IDS_BY_PID[pid].push(did);
          }
          pids[project] = pid;
          titles[project] = rows[i].title;
          
          DATASET_NAME_BY_DID[did] = dataset;
          
    	  
          if (project === undefined){ continue; }
          if (project in datasetsByProject){
              datasetsByProject[project].push({ did:did, dname:dataset, ddesc: dataset_description});
          } else {
              datasetsByProject[project] =   [{ did:did, dname:dataset, ddesc: dataset_description }];
          }

    }

    // todo: console.log(datasetsByProject.length); datasetsByProject - not an array
    for (var p in datasetsByProject){
      var tmp = {};
      tmp.name = p;
      tmp.pid = pids[p];
      tmp.title = titles[p];
      tmp.datasets = [];
      for (var d in datasetsByProject[p]){
        var ds = datasetsByProject[p][d].dname;
        var dp_did = datasetsByProject[p][d].did;  
        var ddesc = datasetsByProject[p][d].ddesc; 
        tmp.datasets.push({ did:dp_did, dname:ds, ddesc:ddesc });
      }
      ALL_DATASETS.projects.push(tmp);
    }
	
    console.log(&#039;Cleaning Metadata&#039;);
    var clean_metadata = {};
    for(did in AllMetadata){
          if(did in DATASET_NAME_BY_DID){
              clean_metadata[did] = AllMetadata[did];        
              for(var mdname in AllMetadata[did] ){
          		//console.log(mdname)
          		if(AllMetadataNames.indexOf(mdname) == -1){
          			AllMetadataNames.push(mdname);
          		}
          		if(mdname == &#039;latitude&#039; || mdname == &#039;longitude&#039;){
  			
          			if(did in DatasetsWithLatLong){
          				if(mdname == &#039;latitude&#039;){				
          					DatasetsWithLatLong[did].latitude = AllMetadata[did].latitude;
          				}else{
          					DatasetsWithLatLong[did].longitude = AllMetadata[did].longitude;
          				}
          			}else{
          				DatasetsWithLatLong[did]={};
        				
        				var pname = PROJECT_INFORMATION_BY_PID[PROJECT_ID_BY_DID[did]].project;
        				DatasetsWithLatLong[did].proj_dset = pname+&#039;--&#039;+DATASET_NAME_BY_DID[did];
          				if(mdname == &#039;latitude&#039;){				
          					DatasetsWithLatLong[did].latitude = AllMetadata[did].latitude;
          				}else{
          					DatasetsWithLatLong[did].longitude = AllMetadata[did].longitude;
          				}
          			}
          		}
          	  }
         }
    }
    AllMetadata = clean_metadata;
    AllMetadataNames.sort();

    connection.query(queries.get_project_permissions(), function(err, rows, fields){ 
      //console.log(qSequenceCounts)
      if (err)  {
        console.log(&#039;Query error: &#039; + err);
        console.log(err.stack);
        process.exit(1);
      } else {
        module.exports.run_permissions_query(rows);          
      }
      
      console.log(&#039; UPDATING PERMISSIONS&#039;);
    });
	

};
//
//
//
module.exports.run_select_sequences_query = function(rows){
        for (var i=0; i &lt; rows.length; i++) {
        //console.log(rows[i].project_id);
          var pid = rows[i].project_id;
          var did = rows[i].dataset_id;
          var count= rows[i].seq_count;
		      var cid  =  rows[i].classifier_id;
          ALL_DCOUNTS_BY_DID[did] = parseInt(count);
          ALL_CLASSIFIERS_BY_PID[pid] = ALL_CLASSIFIERS_BY_CID[cid];

          if(pid in ALL_PCOUNTS_BY_PID){
             ALL_PCOUNTS_BY_PID[pid] += parseInt(count);
          }else{
             ALL_PCOUNTS_BY_PID[pid] = parseInt(count);
          }
        }

};
module.exports.run_ranks_query = function(rank,rows){
        for (var i=0; i &lt; rows.length; i++) {
		      var id = rows[i][rank+&#039;_id&#039;];
          var name = rows[i][rank];
          RANK_ID_BY_NAME[rank][name] = id;
        }
};
module.exports.run_permissions_query = function(rows){
        //
        //console.log(PROJECT_INFORMATION_BY_PID)
        for (var i=0; i &lt; rows.length; i++) {
          var pid = rows[i].project_id;
          var uid = rows[i].user_id;
          
          if(pid in PROJECT_INFORMATION_BY_PID ){
            var project = PROJECT_INFORMATION_BY_PID[pid].project;
            PROJECT_INFORMATION_BY_PNAME[project] =  PROJECT_INFORMATION_BY_PID[pid];
            if(PROJECT_INFORMATION_BY_PID[pid].public === 1 || PROJECT_INFORMATION_BY_PID[pid].username === &#039;guest&#039;){
              PROJECT_INFORMATION_BY_PID[pid].permissions = [];
            }else{
              if(PROJECT_INFORMATION_BY_PID[pid].permissions.indexOf(uid) === -1){
                PROJECT_INFORMATION_BY_PID[pid].permissions.push(uid);
              }
            }
          }          
        }
        //console.log(PROJECT_INFORMATION_BY_PID)
};
module.exports.update_global_variables = function(pid,type){
	if(type==&#039;del&#039;){
		var dids= DATASET_IDS_BY_PID[pid];
		var pname = PROJECT_INFORMATION_BY_PID[pid].project;
		console.log(&#039;RE-INTIALIZING ALL_DATASETS&#039;);
		dataset_objs = [];
        for(var i in ALL_DATASETS.projects){
			item = ALL_DATASETS.projects[i];
			console.log(&#039;item&#039;+item);
            // {&quot;name&quot;:&quot;142&quot;,&quot;pid&quot;:105,&quot;title&quot;:&quot;Title&quot;,&quot;datasets&quot;:[{&quot;did&quot;:496,&quot;dname&quot;:&quot;142_ds&quot;,&quot;ddesc&quot;:&quot;142_ds_description&quot;}]
			if(item.pid == pid){
                dataset_objs = item.datasets;
				console.log(&#039;SPLICING &#039;+pid);
                ALL_DATASETS.projects.splice(i,1);
				break;
			}
			
		}
    console.log(&#039;RE-INTIALIZING PROJECT_ID_BY_DID&#039;);
    console.log(&#039;RE-INTIALIZING DATASET_NAME_BY_DID&#039;);
    console.log(&#039;RE-INTIALIZING ALL_DCOUNTS_BY_DID&#039;);
    for(var d in dids){
    			
      delete PROJECT_ID_BY_DID[dids[d]];
      delete DATASET_NAME_BY_DID[dids[d]];
      delete ALL_DCOUNTS_BY_DID[dids[d]];
      delete DatasetsWithLatLong[dids[d]];
    }
    console.log(&#039;RE-INTIALIZING PROJECT_INFORMATION_BY_PID&#039;);
    console.log(&#039;RE-INTIALIZING DATASET_IDS_BY_PID&#039;);
    console.log(&#039;RE-INTIALIZING ALL_PCOUNTS_BY_PID&#039;);
    console.log(&#039;RE-INTIALIZING ALL_CLASSIFIERS_BY_PID&#039;);
    console.log(&#039;RE-INTIALIZING PROJECT_INFORMATION_BY_PNAME&#039;);
    console.log(&#039;RE-INTIALIZING DatasetsWithLatLong&#039;);
    
    delete PROJECT_INFORMATION_BY_PID[pid];
    delete DATASET_IDS_BY_PID[pid];
    delete ALL_PCOUNTS_BY_PID[pid];
    delete ALL_CLASSIFIERS_BY_PID[pid];
    delete PROJECT_INFORMATION_BY_PNAME[pname];
		
	}else if(type==&#039;add&#039;){
		
	}else{
		// ERROR
	}
};
module.exports.get_status = function(user, project){
    var statQuery=&#039;&#039;;
    statQuery += &quot;SELECT status,message from user_project_status&quot;;  
    statQuery += &quot; WHERE user=&#039;&quot;+user+&quot;&#039; and project =&#039;&quot;+project+&quot;&#039; &quot;;
    console.log(statQuery)
        connection.query(statQuery , function(err, rows, fields){
              if(err) { console.log(&#039;ERROR-in status query: &#039;+err); 
            }else{
              return rows;
            } 
                           
    });
}
module.exports.update_status = function(status_params){
  console.log(&#039;in update_status&#039;)
  if(status_params.type == &#039;delete&#039;){
        var statQuery =&#039;&#039;
        statQuery += &quot;DELETE from user_project_status&quot;;  
        statQuery += &quot; WHERE user=&#039;&quot;+status_params.user+&quot;&#039; and project =&#039;&quot;+status_params.project+&quot;&#039; &quot;;
        console.log(&#039;query: &#039;+statQuery)
        connection.query(statQuery , function(err, rows, fields){
              if(err) { console.log(&#039;ERROR1-in status update: &#039;+err); }               
        });
  }else if(status_params.type == &#039;update&#039;){
        
              var statQuery2 =&#039;&#039;
              if(&#039;pid&#039; in status_params &amp;&amp; &#039;project&#039; in status_params){  
                  statQuery2 += &quot;UPDATE user_project_status set status=&#039;&quot;+status_params.status+&quot;&#039;, message=&#039;&quot;+status_params.msg+&quot;&#039;&quot;;  
                  statQuery2 += &quot; WHERE user=&#039;&quot;+status_params.user+&quot;&#039; and project =&#039;&quot;+status_params.project+&quot;&#039; and project_id=&#039;&quot;+status_params.pid+&quot;&#039;&quot;;
              }else if(&#039;pid&#039; in status_params){
                  statQuery2 += &quot;UPDATE user_project_status set status=&#039;&quot;+status_params.status+&quot;&#039;, message=&#039;&quot;+status_params.msg+&quot;&#039;&quot;;  
                  statQuery2 += &quot; WHERE user=&#039;&quot;+status_params.user+&quot;&#039; and project_id=&#039;&quot;+status_params.pid+&quot;&#039;&quot;;
              }else if(&#039;project&#039; in status_params){  
                  statQuery2 += &quot;UPDATE user_project_status set status=&#039;&quot;+status_params.status+&quot;&#039;, message=&#039;&quot;+status_params.msg+&quot;&#039;&quot;;  
                  statQuery2 += &quot; WHERE user=&#039;&quot;+status_params.user+&quot;&#039; and project =&#039;&quot;+status_params.project+&quot;&#039;&quot;;
              }else{
                //ERROR
              }
              console.log(&#039;query2: &#039;+statQuery2)
              connection.query(statQuery2 , function(err, rows, fields){
                    if(err) { 
                      console.log(&#039;ERROR2-in status update: &#039;+err); 
                    }else{
                      console.log(&#039;status update2&#039;); 
                    } 
              }); 
                        
        
  } else {
      var statQuery1 =&#039;&#039;
      if(&#039;pid&#039; in status_params &amp;&amp; &#039;project&#039; in status_params){        
        statQuery1 += &quot;INSERT IGNORE into user_project_status (user,project,project_id,status,message)&quot;;          
        statQuery1 += &quot; VALUES (&#039;&quot;+status_params.user+&quot;&#039;,&#039;&quot;+status_params.project+&quot;&#039;,&#039;&quot;+status_params.pid+&quot;&#039;,&#039;&quot;+status_params.status+&quot;&#039;,&#039;&quot;+status_params.msg+&quot;&#039;)&quot;;
      }else if(&#039;pid&#039; in status_params){
        statQuery1 += &quot;INSERT IGNORE into user_project_status (user,project_id,status,message)&quot;;          
        statQuery1 += &quot; VALUES (&#039;&quot;+status_params.user+&quot;&#039;,&#039;&quot;+status_params.pid+&quot;&#039;,&#039;&quot;+status_params.status+&quot;&#039;,&#039;&quot;+status_params.msg+&quot;&#039;)&quot;;
      }else if(&#039;project&#039; in status_params){
        statQuery1 += &quot;INSERT IGNORE into user_project_status (user,project,status,message)&quot;;          
        statQuery1 += &quot; VALUES (&#039;&quot;+status_params.user+&quot;&#039;,&#039;&quot;+status_params.project+&quot;&#039;,&#039;&quot;+status_params.status+&quot;&#039;,&#039;&quot;+status_params.msg+&quot;&#039;)&quot;;
      }else{
        // ERROR
      }
      console.log(&#039;query1: &#039;+statQuery1);

      connection.query(statQuery1 , function(err, rows, fields){
            if(err) { 
              console.log(&#039;ERROR1-in status update: &#039;+err); 
            }else{
              console.log(&#039;status update1&#039;); 
            }
      });
  }       
  
}

module.exports.assignment_finish_request = function(res, rows1, rows2, status_params) {
        console.log(&#039;query ok1 &#039;+JSON.stringify(rows1));   // queries.get_select_datasets_queryPID
        console.log(&#039;query ok2 &#039;+JSON.stringify(rows2));	// queries.get_select_sequences_queryPID	           
        this.run_select_datasets_query(rows1);
        console.log(&#039; UPDATED ALL_DATASETS&#039;);
        console.log(&#039; UPDATED PROJECT_ID_BY_DID&#039;);
        console.log(&#039; UPDATED PROJECT_INFORMATION_BY_PID&#039;);
        console.log(&#039; UPDATED PROJECT_INFORMATION_BY_PNAME&#039;);
        console.log(&#039; UPDATED DATASET_IDS_BY_PID&#039;);
        console.log(&#039; UPDATED DATASET_NAME_BY_DID&#039;);
        console.log(&#039; UPDATED AllMetadataNames&#039;);
        console.log(&#039; UPDATED DatasetsWithLatLong&#039;);
        this.run_select_sequences_query(rows2);
        console.log(&#039; UPDATED ALL_DCOUNTS_BY_DID&#039;);
        console.log(&#039; UPDATED ALL_PCOUNTS_BY_PID &#039;+JSON.stringify(ALL_PCOUNTS_BY_PID));
        console.log(&#039; UPDATED ALL_CLASSIFIERS_BY_PID&#039;);
        // re-run re-create new_taxonomy (see app.js)
        var silvaTaxonomy = require(&#039;../../models/silva_taxonomy&#039;);
        var all_silva_taxonomy = new silvaTaxonomy();
        var CustomTaxa  = require(&#039;./custom_taxa_class&#039;);
        all_silva_taxonomy.get_all_taxa(function(err, results) {
          if (err)
            throw err; // or return an error message, or something
          else
            new_taxonomy = new CustomTaxa(results);
            new_taxonomy.make_html_tree_file(new_taxonomy.taxa_tree_dict_map_by_id, new_taxonomy.taxa_tree_dict_map_by_rank[&quot;domain&quot;]);    
        });
        console.log(&#039; UPDATED new_taxonomy&#039;);

        
};
module.exports.reverse = function (str) {
  return str.split(&quot;&quot;).reverse().join(&quot;&quot;);
};

module.exports.update_metadata_from_file = function (){
    var meta_file      = path.join(process.env.PWD,&#039;public&#039;,&#039;json&#039;,NODE_DATABASE+&#039;--metadata.json&#039;);
    try {
      AllMetadata        = require(meta_file);
    }
    catch (e) {
      console.log(e);
      AllMetadata = {}
    }
}
module.exports.mysql_real_escape_string = function (str) {
    return str.replace(/[\0\x08\x09\x1a\n\r&quot;&#039;\\\%]/g, function (char) {
        switch (char) {
            case &quot;\0&quot;:
                return &quot;\\0&quot;;
            case &quot;\x08&quot;:
                return &quot;\\b&quot;;
            case &quot;\x09&quot;:
                return &quot;\\t&quot;;
            case &quot;\x1a&quot;:
                return &quot;\\z&quot;;
            case &quot;\n&quot;:
                return &quot;\\n&quot;;
            case &quot;\r&quot;:
                return &quot;\\r&quot;;
            case &quot;\&quot;&quot;:
            case &quot;&#039;&quot;:
            case &quot;\\&quot;:
            case &quot;%&quot;:
                return &quot;\\&quot;+char; // prepends a backslash to backslash, percent,
                                  // and double/single quotes
        }
    });
};</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
