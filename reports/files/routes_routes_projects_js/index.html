<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - routes/routes_projects.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>routes/routes_projects.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">57.06</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">240</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">15.83</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">0.80</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">var express = require(&#039;express&#039;);
var router = express.Router();
var fs   = require(&#039;fs&#039;);
var nodemailer = require(&#039;nodemailer&#039;);
var transporter = nodemailer.createTransport();
var zlib = require(&#039;zlib&#039;);
var Readable = require(&#039;stream&#039;).Readable;
var helpers = require(&#039;./helpers/helpers&#039;);
var path = require(&#039;path&#039;);
//var crypto = require(&#039;crypto&#039;);
// These are all under /projects
/* GET New User page. */
router.get(&#039;/projects_index&#039;, function(req, res) {
    var db = req.db;
    
    //console.log(ALL_DATASETS);
	console.log(PROJECT_INFORMATION_BY_PID)
  	
   // var info = PROJECT_INFORMATION_BY_PID
  // console.log(info);
    res.render(&#039;projects/projects_index&#039;, { 
                        title          : &#039;VAMPS Projects&#039;,
                        projects    : JSON.stringify(PROJECT_INFORMATION_BY_PID),
                        //data: JSON.stringify(info),
                        user: req.user,hostname: req.C.hostname,
                });
    

});

router.get(&#039;/:id&#039;, helpers.isLoggedIn, function(req, res) {
    var db = req.db;
    var dsinfo = []; 
    var mdata = {}
    var dscounts = {};  
    
	  if(req.params.id in PROJECT_INFORMATION_BY_PID){
      var info = PROJECT_INFORMATION_BY_PID[req.params.id]
      var project_count = ALL_PCOUNTS_BY_PID[req.params.id]
      

      dataset_counts = {};
      for(n in ALL_DATASETS.projects){        
        if(ALL_DATASETS.projects[n].pid == req.params.id){
          dsinfo = ALL_DATASETS.projects[n].datasets;
        }
      }
      for(n in dsinfo){
        var did = dsinfo[n].did;
        dscounts[did] = ALL_DCOUNTS_BY_DID[did];
        mdata[dsinfo[n].dname] = AllMetadata[did]; 

      }
      //console.log(&#039;MD: &#039;+JSON.stringify(mdata));
      var abstract_file = info.project+&#039;.json&#039;;
      var abstract_file_path = path.join(process.env.PWD,&#039;public&#039;,&#039;json&#039;,NODE_DATABASE+&#039;--abstracts&#039;,abstract_file)
      
      
      fs.readFile(abstract_file_path, {encoding: &#039;utf-8&#039;}, function(err,data){
            if (err){            
                //console.log(&#039;ERR &#039;+err)
                abstract = &#039;{&quot;abstract&quot;:&quot;Not Available&quot;}&#039;;
            }else{
              //abstract = JSON.parse(data);
              //console.log(&#039;project: &#039;+info.project+&#039; AB: &#039;+data)
              //console.log(&#039;PROJECT_INFORMATION_BY_PID&#039;,JSON.stringify(PROJECT_INFORMATION_BY_PID))
              abstract = data;
            }

            res.render(&#039;projects/profile&#039;, { 
                                          title  : &#039;VAMPS Project&#039;,
                                          info: JSON.stringify(info),
                                          dsinfo: dsinfo,
                                          dscounts: JSON.stringify(dscounts),
                                          pid: req.params.id,
                                          mdata: JSON.stringify(mdata),
                                          pcount: project_count,
                                          message: &#039;&#039;,
                                          abstract:abstract,
                                          user   : req.user,hostname: req.C.hostname,
                                        });

      });
      
  }else{
      req.flash(&#039;message&#039;,&#039;not found&#039;)
      res.redirect(req.get(&#039;referer&#039;));
      //return
  }
    
});

// router.post(&#039;/download_project_metadata_all&#039;, function(req, res) {
//     var db = req.db;
//     console.log(req.body);
//     var pid = req.body.project_id
//     var project = req.body.project
//     var timestamp = +new Date();  // millisecs since the epoch!
//     var user = req.user || &#039;no-user&#039;;
//     timestamp = user + &#039;_&#039; + timestamp;

//     // check if custom metadata table exists
//     //var qSelect = &quot;SHOW tables like &#039;custom_metadata_&quot;+pid+&quot;&#039;&quot;;
    
//     // get the fields from required_metadata_info as they may vary
//     //var qSelect = &quot;SHOW columns from required_metadata_info&quot;;
//     //console.log(&#039;in projects--&gt;&#039;);
//     //console.log(MetadataValues);
//     //console.log(&#039;&lt;--in projects&#039;);
//     // we have all the metadata in MetadataValues by did
//     var q = &quot;select dataset_id as did from dataset where project_id=&#039;&quot;+pid+&quot;&#039;&quot; 
//     var gzip = zlib.createGzip();
//     var myrows = {}; // myrows[mdname] == [] list of values
//     var header = &#039;Project: &#039;+project+&quot;\n\t&quot;
//     var out_file = &#039;downloads/&#039;+timestamp+&#039;_&#039;+project+&#039;.metadata.gz&#039;;
//     var wstream = fs.createWriteStream(out_file);
//     var rs = new Readable;
//     var filetxt;
//     var collection = db.query(q, function (err, rows, fields){
//       if (err) {
//           throw err;
//       } else {
//         for(i in rows){
//           did = rows[i].did
//           dname = DATASET_NAME_BY_DID[did]
//           header += dname+&quot;\t&quot;
//           for(k in MetadataValues[did]){
//             nm = k
//             val = MetadataValues[did][k]
//             if(nm in myrows){
//               myrows[nm].push(val)
//             }else{
//               myrows[nm] = []
//               myrows[nm].push(val)
//             }
//           }
//         }
//       }
//       // print
//       header += &quot;\n&quot;
//       rs.push(header)
//       if(Object.keys(myrows).length === 0){
//         rs.push(&quot;NO METADATA FOUND\n&quot;)
//       }else{
//         for(mdname in myrows){
//           filetxt = mdname+&quot;\t&quot;  // restart sting
//           for(i in myrows[mdname]){
//             filetxt += myrows[mdname][i]+&quot;\t&quot;
//           }
//           filetxt += &quot;\n&quot;;
//           rs.push(filetxt)
//         }
//       }
//       rs.push(null); 
//       rs
//         .pipe(gzip)
//         .pipe(wstream)
//         .on(&#039;finish&#039;, function () {  // finished
//           console.log(&#039;done compressing and writing file&#039;);
//           var info = { 
//                 &quot;addr&quot;:&#039;avoorhis@mbl.edu&#039;,
//                 &quot;from&quot;:&quot;vamps@mbl.edu&quot;,
//                 &quot;subj&quot;:&quot;metadata is ready&quot;,
//                 &quot;msg&quot;:&quot;Your metadata file is ready here:\n\nhttp://localhost:3000/&quot;+&quot;export_data/&quot;
//               }
//           send_mail(info);
//           // transporter.sendMail({
//           //   from: &#039;vamps@mbl.edu&#039;,
//           //   to: &#039;avoorhis@mbl.edu&#039;,
//           //   subject: &#039;metadata is ready&#039;,
//           //   text: &quot;Your metadata file is ready here:\n\nhttp://localhost:3000/&quot;+&quot;export_data/&quot;
//           // });
//         });

//     });
//     //console.log(datasets);
// });


// move to routes/download.js
// router.post(&#039;/download_project_seqs_all&#039;, function(req, res) {
//     var db = req.db;
//     console.log(req.body);
//     var pid = req.body.project_id
//     var project = req.body.project
//     var seq, seqid, seq_count, pjds;
//     var timestamp = +new Date();  // millisecs since the epoch!
//     var user = req.user || &#039;no-user&#039;;
//     timestamp = user + &#039;_&#039; + timestamp;
    
//     var qSelect = &quot;select UNCOMPRESS(sequence_comp) as seq, sequence_id, seq_count, dataset from sequence_pdr_info\n&quot;;
//     //var qSelect = &quot;select sequence_comp as seq, sequence_id, seq_count, dataset from sequence_pdr_info\n&quot;;
//     qSelect += &quot; join sequence using (sequence_id)\n&quot;;
//     qSelect += &quot; join dataset using (dataset_id)\n&quot;;
//     qSelect += &quot; join project using (project_id)\n&quot;;
//     qSelect += &quot; where project_id = &#039;&quot;+pid+&quot;&#039;&quot;;
//     qSelect += &quot; limit 100 &quot;;                     // &lt;&lt;&lt;&lt;-----  for testing
//     var gzip = zlib.createGzip();
//     console.log(qSelect);
//     var out_file = &#039;downloads/&#039;+timestamp+&#039;_&#039;+project+&#039;.fa.gz&#039;;
//     var wstream = fs.createWriteStream(out_file);
//     var rs = new Readable;
//     var collection = db.query(qSelect, function (err, rows, fields){
//       if (err) {
//           throw err;
//       } else {
//         for(i in rows){
//           seq = rows[i].seq.toString();
//           //var buffer = new Buffer(rows[i].seq, &#039;base64&#039;);
          
//           //console.log(seq);
//           seq_id = rows[i].sequence_id.toString();
//           seq_count = rows[i].seq_count.toString();
//           pjds = project+&#039;--&#039;+rows[i].dataset;
//           entry = &#039;&gt;&#039;+seq_id+&#039;|&#039;+pjds+&#039;|&#039;+seq_count+&quot;\n&quot;+seq+&quot;\n&quot;
//           //console.log(entry)
//           rs.push(entry)         
//         }
       
//         rs.push(null);        
//       }
//       rs
//         .pipe(gzip)
//         .pipe(wstream)
//         .on(&#039;finish&#039;, function () {  // finished
//           console.log(&#039;done compressing and writing file&#039;);
//           transporter.sendMail({
//             from: &#039;vamps@mbl.edu&#039;,
//             to: &#039;avoorhis@mbl.edu&#039;,
//             subject: &#039;fasta is ready&#039;,
//             text: &quot;Your fasta file is ready here:\n\nhttp://localhost:3000/&quot;+&quot;export_data/&quot;
//           });
//         });
//     });

// });



module.exports = router;</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
