<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - routes/routes_search.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>routes/routes_search.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">53.62</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">886</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">83.98</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">11.27</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">var express = require(&#039;express&#039;);
var router = express.Router();
var passport = require(&#039;passport&#039;);
var helpers = require(&#039;./helpers/helpers&#039;);
var fs   = require(&#039;fs-extra&#039;);
var path  = require(&#039;path&#039;);

/* GET Search page. */
router.get(&#039;/search_index&#039;, helpers.isLoggedIn, function(req, res) {
    
    //console.log(metadata_fields)
    res.render(&#039;search/search_index&#039;, { title: &#039;VAMPS:Search&#039;,
        message:         req.flash(&#039;message&#039;),
        user:            req.user,hostname: req.CONFIG.hostname,
    		});
});
//
//
//
router.get(&#039;/users&#039;, helpers.isLoggedIn, function(req, res) {

    res.render(&#039;search/users&#039;, { title: &#039;VAMPS:Search&#039;,
        message:              req.flash(&#039;message&#039;),
        user:                 req.user,hostname: req.CONFIG.hostname,
    });
});
//
//
//
router.get(&#039;/names&#039;, helpers.isLoggedIn, function(req, res) {

    res.render(&#039;search/names&#039;, { title: &#039;VAMPS:Search&#039;,
        
        message:              req.flash(&#039;message&#039;),
        
        user:                 req.user,hostname: req.CONFIG.hostname,
    });
});
//
//
//
router.get(&#039;/blast&#039;, helpers.isLoggedIn, function(req, res) {
    var blast_db = req.CONSTS.blast_db;
    // check if blast database exists:
    var blast_nin = path.join(&#039;public&#039;,&#039;blast&#039;, NODE_DATABASE, blast_db+&#039;.nin&#039;);
    console.log(blast_nin);
    try{
      stats = fs.lstatSync(blast_nin);
      if (stats.isFile()) {
        var blast_db_path = path.join(&#039;public&#039;,&#039;blast&#039;, NODE_DATABASE, blast_db);
      }else{
        var blast_db_path = false;
      }
    }
    catch (e){
      console.log(e);
    }
    res.render(&#039;search/blast&#039;, { title: &#039;VAMPS:Search&#039;,
        blast_db_path:blast_db_path,
        message:              req.flash(&#039;message&#039;),
        
        user:                 req.user,hostname: req.CONFIG.hostname,
    });
});
//
//
//
router.get(&#039;/taxonomy&#039;, helpers.isLoggedIn, function(req, res) {

    res.render(&#039;search/taxonomy&#039;, { title: &#039;VAMPS:Search&#039;,
        
        message:              req.flash(&#039;message&#039;),
        
        user:                 req.user,hostname: req.CONFIG.hostname,
    });
});
//
//
//
router.get(&#039;/metadata/:type&#039;, helpers.isLoggedIn, function(req, res) {
      
      console.log(&#039;in by &#039;+req.params.type)

      var tmp_metadata_fields = {};
      var metadata_fields = {};
      var metadata_fields_array = [];
      
      if(HDF5_MDATA == &#039;&#039;){
            for (var did in AllMetadata){
                for (var name in AllMetadata[did]){
                    val = AllMetadata[did][name];
                    if(name in tmp_metadata_fields){
                      tmp_metadata_fields[name].push(val);
                    }else{
                      if(IsNumeric(val)){
                        tmp_metadata_fields[name]=[];
                      }else{
                        tmp_metadata_fields[name]=[&#039;non-numeric&#039;];
                      }
                      tmp_metadata_fields[name].push(val);
                    }
                }
            }
      }else{
      
          for(did in DATASET_NAME_BY_DID){
            var group = HDF5_MDATA.openGroup(did+&quot;/metadata&quot;);
            group.refresh()
            Object.getOwnPropertyNames(group).forEach(function(mdname, idx, array) {
              if(mdname != &#039;id&#039;){         
                if(mdname in tmp_metadata_fields){
                  tmp_metadata_fields[mdname].push(group[mdname]);
                }else{
                  if(IsNumeric(group[mdname])){
                    tmp_metadata_fields[mdname]=[];
                  }else{
                    tmp_metadata_fields[mdname]=[&#039;non-numeric&#039;];
                  }
                  tmp_metadata_fields[mdname].push(group[mdname]);
                }
              }        
            });
          }
      }

      
    
      for (var tmp_name in tmp_metadata_fields){
        metadata_fields_array.push(tmp_name);
        if(tmp_metadata_fields[tmp_name][0] == &#039;non-numeric&#039;){
          tmp_metadata_fields[tmp_name].shift(); //.filter(onlyUnique);
          metadata_fields[tmp_name] = tmp_metadata_fields[tmp_name].filter(onlyUnique);
        }else{
          var min = Math.min.apply(null, tmp_metadata_fields[tmp_name]);
          var max = Math.max.apply(null, tmp_metadata_fields[tmp_name]);
          metadata_fields[tmp_name] = {&quot;min&quot;:min,&quot;max&quot;:max};
        }
      }
      //console.log(metadata_fields)
      metadata_fields_array.sort();


      res.render(&#039;search/metadata&#039;, { title: &#039;VAMPS:Search&#039;,
        metadata_items:       JSON.stringify(metadata_fields),
        metadata_search_type: req.params.type,
        message:              req.flash(&#039;message&#039;),
        mkeys:                metadata_fields_array,
        user:                 req.user,hostname: req.CONFIG.hostname,
      });
})
//
//  TAXONOMY SEARCH
//
router.post(&#039;/taxonomy_search_for_datasets&#039;, helpers.isLoggedIn, function(req, res) {
	console.log(&#039;in tax search result&#039;);
    console.log(&#039;req.body--&gt;&gt;&#039;);
    console.log(req.body);
    console.log(&#039;&lt;&lt;--req.body&#039;);
	

  if(! req.body.tax_string){
		req.flash(&#039;tax_message&#039;, &#039;Error&#039;);
		res.redirect(&#039;search_index#taxonomy&#039;);
    return;
	}
	var tax_string = req.body.tax_string;
	tax_items = tax_string.split(&#039;;&#039;);
	if(req.body.selection == &#039;custom_taxonomy&#039;){		
		qSelect = &quot;SELECT distinct dataset_id as did from sequence_pdr_info\n&quot;;
	}else{
		// ERROR
	}
	
	qSelect += &quot; JOIN silva_taxonomy_info_per_seq using (sequence_id)\n&quot;;
	qSelect += &quot; JOIN silva_taxonomy using (silva_taxonomy_id)\n&quot;;
	add_where = &#039; WHERE &#039;;
	for(var n in tax_items){
		rank = req.CONSTS.RANKS[n];
		qSelect += &#039; JOIN `&#039;+rank+ &#039;` using (&#039;+rank+&#039;_id)\n&#039;;
		add_where += &#039;`&#039;+rank+&quot;`=&#039;&quot;+tax_items[n]+&quot;&#039; and &quot; ;
	}
	qSelect = qSelect + add_where.substring(0, add_where.length - 5);
	console.log(qSelect);
	var query = req.db.query(qSelect, function (err, rows, fields){
    if (err) {
        req.flash(&#039;tax_message&#039;, &#039;SQL Error: &#039;+err);
        res.redirect(&#039;search_index#taxonomy&#039;);
    } else {
      var datasets = {};
      datasets.ids = [];
      datasets.names = [];
      for(var n in rows){
        console.log(rows[n]);
        did = rows[n][&#039;did&#039;];
        pid = PROJECT_ID_BY_DID[did];
        pname = PROJECT_INFORMATION_BY_PID[pid].project;
        datasets.ids.push(did);
        datasets.names.push(pname+&#039;--&#039;+DATASET_NAME_BY_DID[did]);
      }
      console.log(datasets);
      var timestamp = +new Date();  // millisecs since the epoch!
      var filename = &#039;datasets:&#039;+timestamp+&#039;.json&#039;;
      var filename_path = path.join(req.CONFIG.USER_FILES_BASE,req.user.username,filename);
      helpers.mkdirSync(req.CONFIG.USER_FILES_BASE);  // create dir if not present
      helpers.mkdirSync(path.join(req.CONFIG.USER_FILES_BASE,req.user.username)); // create dir if not present
      //console.log(filename);
      helpers.write_to_file(filename_path,JSON.stringify(datasets));
      msg = &quot;&lt;a href=&#039;/visuals/saved_datasets&#039;&gt;&quot;+filename+&quot;&lt;/a&gt;&quot;;
      req.flash(&#039;tax_message&#039;, &#039;Saved as: &#039;+msg);
      res.redirect(&#039;search_index#taxonomy&#039;);
    }
  });
	
	
	
});
//
//  METADATA SEARCH
//
router.post(&#039;/metadata_search_result&#039;, helpers.isLoggedIn, function(req, res) {
  console.log(&#039;req.body--&gt;&gt;&#039;);
  console.log(req.body);
  console.log(&#039;&lt;&lt;--req.body&#039;);

  var search_function = req.body.search_function;
  var searches = {};
  var allowed = [ &#039;search1&#039;, &#039;search2&#039;, &#039;search3&#039; ];
  if (search_function === &#039;search_metadata_all_datasets&#039;){
    for (var name in req.body){
      items = name.split(&#039;_&#039;);
      var search = items[0];
      if(allowed.indexOf(search) != -1){
        if( !(search  in searches)){
          searches[search] = {};
        }
        searches[search][items[1]] = req.body[name];
      }
    }
  }
  var join_type = req.body.join_type;
  console.log(searches);

  var ds1, ds2, ds3 = [];
  var result = get_search_datasets(req.user, searches.search1);
  ds1 = result.datasets;
  searches.search1.datasets = result.datasets;
  searches.search1.dataset_count = searches.search1.datasets.length;
  searches.search1.ds_plus = get_dataset_search_info(result.datasets, searches.search1);
  console.log(&#039;result1&#039;,result)
  

  if(&#039;search2&#039; in searches){
    
    result = get_search_datasets(req.user, searches.search2);
    ds2 = result.datasets;
    searches.search2.datasets = result.datasets;
    searches.search2.dataset_count = searches.search2.datasets.length;
   
    searches.search2.ds_plus = get_dataset_search_info(result.datasets, searches.search2);

  }

  if(&#039;search3&#039; in searches){
   
    result = get_search_datasets(req.user, searches.search3);
    ds3 = result.datasets;
    searches.search3.datasets = result.datasets;
    searches.search3.dataset_count = searches.search3.datasets.length;
    
    searches.search3.ds_plus = get_dataset_search_info(result.datasets, searches.search3);
  }
  //
  // Calculate (sum or intersect) final datasets
  //
  var filtered = {};
  if(join_type == &#039;combination&#039;){
    filtered.datasets = ds1.concat(ds2, ds3);
    filtered.datasets = filtered.datasets.filter(onlyUnique);
  }else{   // intersection
    filtered.datasets = ds1;
    if(&#039;search2&#039; in searches) {
      filtered.datasets = ds1.filter(function(n) {
          return ds2.indexOf(n) != -1;
      });
    }
    if(&#039;search3&#039; in searches) {
      filtered.datasets = filtered.datasets.filter(function(n) {
          return ds3.indexOf(n) != -1;
      });
    }
  }
  filtered.ds_plus = get_dataset_search_info(filtered.datasets, {});
  //
  //
  
  if(filtered.datasets.length === 0){
  	console.log(&#039;redirecting back -- no data found&#039;);
	  req.flash(&#039;message&#039;, &#039;No Data Found&#039;);
	  res.redirect(&#039;search_index&#039;);
    return;
  }else{
          res.render(&#039;search/search_result_metadata&#039;, {
                    title    : &#039;VAMPS: Search Datasets&#039;,
                    filtered : JSON.stringify(filtered),
                    searches : JSON.stringify(searches),
                    join_type: join_type,
                    user     : req.user,hostname: req.CONFIG.hostname,
          });  //
   }

});
//
//  SEARCH DATASETS
//
router.get(&#039;/gethint/:hint&#039;, helpers.isLoggedIn, function(req, res) {
	//console.log(&#039;in gethint&#039;);
	//console.log(req.params.hint);
	var q = req.params.hint;
	var hint = &#039;&#039;;
	if (q !== &quot;&quot;) {
	    q = q.toLowerCase();
	    len=q.length;
		for(var n in AllMetadataNames){
			var name = AllMetadataNames[n];
			
				if(name.substring(0,len) === q){
          console.log(&#039;name= &#039;+name);
				  if (hint === &quot;&quot;) {
      	              hint = name;
      	            } else {
     	                hint += &quot;--&quot;+name;
      	            }
	        }
	    }
	}
	
	console.log(&#039;hint= &#039;+hint);
	var result = (hint === &quot;&quot;) ? (&quot;No Suggestions&quot;) : (hint);
	console.log(&#039;result= &#039;+result);
	res.send(result);
	
});
//
//  LIVESEARCH TAX
//
router.get(&#039;/livesearch_taxonomy/:q&#039;, helpers.isLoggedIn, function(req, res) {
	//console.log(&#039;params&gt;&gt;&#039;);
	//console.log(req.params);
	//console.log(&#039;&lt;&lt;params&#039;);
	console.log(&#039;in livesearch taxonomy&#039;);
	var q = req.params.q.toLowerCase();
	var hint = &#039;&#039;;
	var obj = new_taxonomy.taxa_tree_dict_map_by_rank;
	var taxon;
	if(q !== &#039;&#039;){
		for(var n in obj[&quot;domain&quot;]){
			taxon = obj[&quot;domain&quot;][n].taxon;
			if(taxon.toLowerCase() != &#039;domain_na&#039; &amp;&amp; taxon.toLowerCase().indexOf(q) != -1){
				hint += &quot;&lt;a href=&#039;&#039; onclick=\&quot;get_tax_str(&#039;&quot;+taxon+&quot;&#039;,&#039;domain&#039;);return false;\&quot; &gt;&quot;+taxon + &quot;&lt;/a&gt; &lt;small&gt;(domain)&lt;/small&gt;&lt;br&gt;&quot;;
			}
		}
		for(var n in obj[&quot;phylum&quot;]){
			taxon = obj[&quot;phylum&quot;][n].taxon;
			t_lower = taxon.toLowerCase();
			if(t_lower != &#039;phylum_na&#039; &amp;&amp; t_lower.indexOf(q) != -1){
				hint += &quot;&lt;a href=&#039;&#039; onclick=\&quot;get_tax_str(&#039;&quot;+taxon+&quot;&#039;,&#039;phylum&#039;);return false;\&quot; &gt;&quot;+taxon + &quot;&lt;/a&gt; &lt;small&gt;(phylum)&lt;/small&gt;&lt;br&gt;&quot;;
			}
		}
		for(var n in obj[&quot;klass&quot;]){
			taxon = obj[&quot;klass&quot;][n].taxon;
			t_lower = taxon.toLowerCase();
			if(t_lower != &#039;klass_na&#039; &amp;&amp; t_lower.indexOf(q) != -1 ){
				hint += &quot;&lt;a href=&#039;&#039; onclick=\&quot;get_tax_str(&#039;&quot;+taxon+&quot;&#039;,&#039;klass&#039;);return false;\&quot; &gt;&quot;+taxon + &quot;&lt;/a&gt; &lt;small&gt;(class)&lt;/small&gt;&lt;br&gt;&quot;;
			}
		}
		for(var n in obj[&quot;order&quot;]){
			taxon = obj[&quot;order&quot;][n].taxon;
			t_lower = taxon.toLowerCase();
			if(t_lower != &#039;order_na&#039; &amp;&amp; t_lower.indexOf(q) != -1){
				hint += &quot;&lt;a href=&#039;&#039; onclick=\&quot;get_tax_str(&#039;&quot;+taxon+&quot;&#039;,&#039;order&#039;);return false;\&quot; &gt;&quot;+taxon + &quot;&lt;/a&gt; &lt;small&gt;(order)&lt;/small&gt;&lt;br&gt;&quot;;
			}
		}
		for(var n in obj[&quot;family&quot;]){
			taxon = obj[&quot;family&quot;][n].taxon;
			t_lower = taxon.toLowerCase();
			if(t_lower != &#039;family_na&#039; &amp;&amp; t_lower.indexOf(q) != -1){
				hint += &quot;&lt;a href=&#039;&#039; onclick=\&quot;get_tax_str(&#039;&quot;+taxon+&quot;&#039;,&#039;family&#039;);return false;\&quot; &gt;&quot;+taxon + &quot;&lt;/a&gt; &lt;small&gt;(family)&lt;/small&gt;&lt;br&gt;&quot;;
			}
		}
		for(var n in obj[&quot;genus&quot;]){
			taxon = obj[&quot;genus&quot;][n].taxon;
			t_lower = taxon.toLowerCase();
			if(t_lower != &#039;genus_na&#039; &amp;&amp; t_lower.indexOf(q) != -1){
				hint += &quot;&lt;a href=&#039;&#039; onclick=\&quot;get_tax_str(&#039;&quot;+taxon+&quot;&#039;,&#039;genus&#039;);return false;\&quot; &gt;&quot;+taxon + &quot;&lt;/a&gt; &lt;small&gt;(genus)&lt;/small&gt;&lt;br&gt;&quot;;
			}
		}
		for(var n in obj[&quot;species&quot;]){
			taxon = obj[&quot;species&quot;][n].taxon;
			t_lower = taxon.toLowerCase();
			if(t_lower != &#039;species_na&#039; &amp;&amp; t_lower.indexOf(q) != -1){
				hint += &quot;&lt;a href=&#039;&#039; onclick=\&quot;get_tax_str(&#039;&quot;+taxon+&quot;&#039;,&#039;species&#039;);return false;\&quot; &gt;&quot;+taxon + &quot; &lt;/a&gt; &lt;small&gt;(species)&lt;/small&gt;&lt;br&gt;&quot;;
			}
		}
		
	}
	var result = (hint === &quot;&quot;) ? (&quot;No Suggestions&quot;) : (hint);
	res.send(result);
});
//
//  LIVESEARCH USER
//
router.get(&#039;/livesearch_user/:q&#039;, helpers.isLoggedIn, function(req, res) {
 
  console.log(&#039;in livesearch user&#039;);
  var q = req.params.q.toLowerCase();
  var hint = &#039;&#039;;
  var obj = ALL_USERS_BY_UID;
  var taxon;
  if(q !== &#039;&#039;){
    for(var uid in obj){
      user  = obj[uid].username;
      last  = obj[uid].last_name;
      first = obj[uid].first_name;

      if(last.toLowerCase().indexOf(q) != -1 || first.toLowerCase().indexOf(q) != -1){
        //hint += &quot;&lt;a href=&#039;&#039; onclick=\&quot;get_user_str(&#039;&quot;+taxon+&quot;&#039;,&#039;domain&#039;);return false;\&quot; &gt;&quot;+taxon + &quot;&lt;/a&gt; &lt;small&gt;(domain)&lt;/small&gt;&lt;br&gt;&quot;;
        //hint += &quot;&lt;a href=&#039;#&#039;&gt;&quot;+last+&#039;, &#039;+first+&#039; (&#039;+user+&quot;)&lt;/a&gt;&lt;br&gt;&quot;;
        hint += &quot;&lt;form method=&#039;GET&#039; action=&#039;/users/&quot;+uid+&quot;&#039;&gt;&quot;;
        hint += &quot;&lt;button type=&#039;submit&#039; id=&#039;&quot;+uid+&quot;&#039; class=&#039;btn btn-xs btn-link&#039; &gt;&quot;+last+&#039;, &#039;+first+&#039; (&#039;+user+&quot;)&lt;/button&gt;&quot;;
        hint += &quot;&lt;/form&gt;&quot;;
      }
    }
  }
  var result = (hint === &quot;&quot;) ? (&quot;No Suggestions&quot;) : (hint);
  res.send(result);
});
//
//  LIVESEARCH PROJECT
//
router.get(&#039;/livesearch_project/:q&#039;, helpers.isLoggedIn, function(req, res) {
  //console.log(&#039;params&gt;&gt;&#039;);
  //console.log(req.params);
  //console.log(&#039;&lt;&lt;params&#039;);
  console.log(&#039;in livesearch project&#039;);
  var q = req.params.q.toLowerCase();
  console.log(&#039;q&#039;,q);
  var hint = &#039;Projects:&lt;br&gt;&#039;;
  var plist = []
  var p_obj = {}
  var dlist = []
  var d_obj = {}
  if(q !== &#039;&#039;){



    
    
    ALL_DATASETS.projects.forEach(function(prj) {
      
      pid = prj.pid
      
      pname = prj.name;
      ptitle = PROJECT_INFORMATION_BY_PID[pid].title;
      pdesc  = PROJECT_INFORMATION_BY_PID[pid].description;
      datasets = prj.datasets;
      
      if(      pname.toLowerCase().indexOf(q) != -1 
            || ptitle.toLowerCase().indexOf(q) != -1 
            || pdesc.toLowerCase().indexOf(q) != -1
        ){
        console.log(pid)
        plist.push(pname)
        p_obj[pname] = {}
        p_obj[pname].pid   = pid
        p_obj[pname].title = ptitle
        p_obj[pname].desc  = pdesc
      }

      datasets.forEach(function(dset) {
        did = dset.did
        dname = dset.dname;
        ddesc = dset.ddesc;
        
        if(    dname.toLowerCase().indexOf(q) != -1 
            || ddesc.toLowerCase().indexOf(q) != -1 
          ){
          console.log(dname)
        dlist.push(dname)
        d_obj[dname] = {}
        d_obj[dname].did = did
        d_obj[dname].desc = ddesc
        d_obj[dname].project = pname
        }

      })


    })
    console.log(plist)
    console.log(&#039;a&#039;)
    dlist.sort()
    plist.sort()
console.log(&#039;b&#039;,plist.length)
    for(i = 0; i &lt; plist.length; i++){
        pname = plist[i]
        //console.log(p_obj.pname.pid)
        console.log(plist[i])
        hint += &quot;&lt;form method=&#039;GET&#039; action=&#039;/projects/&quot;+p_obj[pname].pid+&quot;&#039;&gt;&quot;;
        hint += &quot;&lt;button type=&#039;submit&#039; id=&#039;&quot;+p_obj[pname].pid+&quot;&#039; class=&#039;btn btn-xs btn-link&#039; &gt;&quot;+pname+&quot;&lt;/button&gt; (title: &quot;+p_obj[pname].title+&#039;)&#039;
        hint += &quot;&lt;/form&gt;&quot;;
    }
    console.log(&#039;c&#039;,dlist.length)

    hint += &#039;Datasets:&lt;br&gt;&#039;;
    for(i = 0; i &lt; dlist.length; i++){
        console.log(&#039;ca&#039;)
        dname = dlist[i]
        hint += &quot;&lt;form method=&#039;GET&#039; action=&#039;/projects/&quot;+d_obj[dname].did+&quot;&#039;&gt;&quot;;
        console.log(&#039;cb&#039;)
        hint += &quot;&lt;button type=&#039;submit&#039; id=&#039;&quot;+d_obj[dname].did+&quot;&#039; class=&#039;btn btn-xs btn-link&#039; &gt;&quot;+dname+&quot;&lt;/button&gt; (desc: &quot;+d_obj[dname].desc+&#039;)&#039;
        console.log(&#039;cc&#039;)
        hint += &quot;&lt;/form&gt;&quot;;
    }
     console.log(&#039;d&#039;)
      //if(dname.toLowerCase().indexOf(q) != -1){

      //}
    //})
// { name: &#039;CMP_JJ_ApD1&#039;,
//   pid: 53,
//   title: &#039;Title&#039;,
//   datasets: [ { did: 86, dname: &#039;ApD1&#039;, ddesc: &#039;ApD1_description&#039; } ] }


  }

  console.log(q,&#039;hint&#039;,hint)
  var result = (hint == &#039;Projects:&lt;br&gt;Datasets:&lt;br&gt;&#039;) ? (&quot;No Suggestions&quot;) : (hint);
  res.send(result);
});
//
//
//
router.get(&#039;/livesearch_taxonomy/:rank/:taxon&#039;, helpers.isLoggedIn, function(req, res) {
	var selected_taxon = req.params.taxon;
	var selected_rank = req.params.rank;
  var rank_number = req.CONSTS.RANKS.indexOf(selected_rank);
	console.log(req.params);
	var this_item = new_taxonomy.taxa_tree_dict_map_by_name_n_rank[selected_taxon+&#039;_&#039;+selected_rank];
	var tax_str = selected_taxon;

	var item = this_item;
	console.log(item);
  // goes up the tree to get taxon parents:
  while(item.parent_id !== 0){
		item  = new_taxonomy.taxa_tree_dict_map_by_id[item.parent_id];
		tax_str = item.taxon +&#039;;&#039;+tax_str;
		//console.log(item);
	}


  //console.log(base_taxon);
	console.log(&#039;sending tax_str&#039;);
	res.send(tax_str);
	
});




// }
//
//  BLAST
//
router.post(&#039;/blast_search_result&#039;, helpers.isLoggedIn, function(req, res) {
    console.log(&#039;in blast res&#039;);
    console.log(req.body);
    if(req.body.query === &#039;&#039;){
      //req.flash(&#039;message&#039;, &#039;No Query Sequence Found&#039;);
      res.redirect(&#039;search_index#blast&#039;);
      return;
    }
    var blast_db = req.body.blast_db_path;
    // got query now put it in a file (where?)
    var timestamp = +new Date();  // millisecs since the epoch!
    timestamp = req.user.username + &#039;_&#039; + timestamp;
    var query_file = timestamp+&quot;_blast_query.fa&quot;;
    var query_file_path = path.join(&#039;tmp&#039;,query_file);

    // using blastn with -outfmt 13 option produces 2 files
    var out_file0 = timestamp+&quot;_blast_result.json&quot;;
    var out_file_path0 = path.join(&#039;tmp&#039;,out_file0);
    var out_file1 = timestamp+&quot;_blast_result_1.json&quot;;
    var out_file_path1 = path.join(&#039;tmp&#039;,out_file1);
    // then run &#039;blastn&#039; command
    // blastn -db &lt;dbname&gt; -query &lt;query_file&gt; -outfmt 13 -out &lt;outfile_name&gt;
    fs.writeFile(query_file_path,req.body.query+&quot;\n&quot;,function(err){
      if(err){
        req.flash(&#039;message&#039;, &#039;ERROR - Could not write query file&#039;);
        res.redirect(&#039;search_index&#039;);
      }else{
        var spawn = require(&#039;child_process&#039;).spawn;
        var log = fs.openSync(path.join(process.env.PWD,&#039;logs&#039;,&#039;blast.log&#039;), &#039;a&#039;);
        var blast_options = {
          scriptPath : req.CONFIG.PATH_TO_BLAST,
          args :       [ &#039;-db&#039;, blast_db, &#039;-query&#039;, query_file_path, &#039;-outfmt&#039;,&#039;13&#039;,&#039;-out&#039;,out_file_path0 ],
        };
        //var blastn_cmd = &#039;blastn -db &#039;+blast_db+&#039; -query &#039;+query_file_path+&#039; -outfmt 13 -out &#039;+out_file_path0
        var blast_process = spawn( blast_options.scriptPath+&#039;/blastn&#039;, blast_options.args, {detached: true, stdio: [ &#039;ignore&#039;, null, log ]} );

        blast_process.stdout.on(&#039;data&#039;, function (data) {
          //console.log(&#039;stdout: &#039; + data);
          data = data.toString().replace(/^\s+|\s+$/g, &#039;&#039;);
          var lines = data.split(&#039;\n&#039;);
          for(var n in lines){
            console.log(&#039;blastn line &#039;+lines[n]);
          }
        });
        // AAGTCTTGACATCCCGATGAAAGATCCTTAACCAGATTCCCTCTTCGGAGCATTGGAGAC
        blast_process.on(&#039;close&#039;, function (code) {
         console.log(&#039;blast_process process exited with code &#039; + code);
         if(code === 0){
           console.log(&#039;BLAST SUCCESS&#039;);
           // now read file
           fs.readFile(out_file_path1,&#039;utf8&#039;, function(err, data){
              if(err){
                req.flash(&#039;message&#039;, &#039;ERROR - Could not read blast outfile&#039;);
                res.redirect(&#039;search_index&#039;);
              }else{
                var obj = JSON.parse(data);
                console.log(out_file_path1);
                console.log(data);
                res.render(&#039;search/search_result_blast&#039;, {
                    title    : &#039;VAMPS: BLAST Result&#039;,
                    data     : data,
                    show     : &#039;blast_result&#039;,
                    user     : req.user,hostname: req.CONFIG.hostname,
                });  //

              }
           });

         }else{
            req.flash(&#039;message&#039;, &#039;ERROR - BLAST command exit code: &#039;+code);
            res.redirect(&#039;search_index&#039;);
         }
        });

      }

    });

  });
//
//
//
router.get(&#039;/seqs/:id&#039;, helpers.isLoggedIn, function(req, res) {
  console.log(req.params);
  var seqid = req.params.id;

  q_tax = &quot;SELECT domain,phylum,klass,`order`,family,genus&quot;;
  q_tax += &quot; from silva_taxonomy_info_per_seq&quot;;
  q_tax += &quot; JOIN silva_taxonomy using (silva_taxonomy_id)&quot;;
  q_tax += &quot; JOIN domain using (domain_id)&quot;;
  q_tax += &quot; JOIN phylum using (phylum_id)&quot;;
  q_tax += &quot; JOIN klass using (klass_id)&quot;;
  q_tax += &quot; JOIN `order` using (order_id)&quot;;
  q_tax += &quot; JOIN family using (family_id)&quot;;
  q_tax += &quot; JOIN genus using (genus_id)&quot;;
  q_tax += &quot; WHERE sequence_id=&#039;&quot;+seqid+&quot;&#039;&quot;;

  //we want to know the taxonomy AND which projects
  q_ds = &quot;SELECT dataset_id, seq_count from sequence_pdr_info&quot;;
  q_ds += &quot; WHERE sequence_id=&#039;&quot;+seqid+&quot;&#039;&quot;;
  console.log(q_ds);
  connection.query(q_ds, function(err, rows, fields){
    if(err){
      console.log(err);
    }else{
      var obj = {};

      for(var i in rows){
        did = rows[i].dataset_id;
        cnt = rows[i].seq_count;
        ds  = DATASET_NAME_BY_DID[did];
        pid = PROJECT_ID_BY_DID[did];
        pj  = PROJECT_INFORMATION_BY_PID[pid].project;
        //console.log(did)
        //console.log(ds)
        //console.log(pj)
        if(pj in obj){
          obj[pj][ds] = cnt;
        }else{
          obj[pj] = {};
          obj[pj][ds] = cnt;

        }

      }
      //console.log(obj);
      //console.log(JSON.stringify(obj));
      // AAGTCTTGACATCCCGATGAAAGATCCTTAACCAGATTCCCTCTTCGGAGCATTGGAGAC
      res.render(&#039;search/search_result_blast&#039;, {
                    title    : &#039;VAMPS: BLAST Result&#039;,
                    show     : &#039;datasets&#039;,
                    seqid    : seqid,
                    obj      : JSON.stringify(obj),
                    user     : req.user,hostname: req.CONFIG.hostname,
                });  //
      }
  });

});

router.get(&#039;/make_a_blast_db&#039;, helpers.isLoggedIn, function(req, res) {
  var txt = &quot;&lt;br&gt;&lt;br&gt;&quot;;
  txt += &quot;&lt;li&gt;Install local ncbi-blast from: http://blast.ncbi.nlm.nih.gov/Blast.cgi?PAGE_TYPE=BlastDocs&amp;DOC_TYPE=Download&lt;br&gt;&quot;;
  txt += &quot;&lt;li&gt;Make a fasta file of all seqs to be included in blast db using the db2fasta.py script in the public/scripts directory&lt;br&gt;&quot;;
  txt += &quot;The &#039;makeblastdb&#039; command is part of the ncbi-blast suite of commands&lt;br&gt;&quot;;
  txt += &quot;Run the &#039;makeblastdb&#039; command as shown:&lt;br&gt;&quot;;
  txt += &quot;/&gt;makeblastdb -in new_fasta.fa -parse_seqids -dbtype nucl -out ALL_SEQS&lt;br&gt;&lt;br&gt;&quot;;
  txt += &quot;&lt;li&gt;Then move the newly created files into the directory /public/blast/&amp;lt;NODE_DATABASE_NAME&amp;gt;&lt;br&gt;&quot;;
  txt += &quot;&lt;li&gt;The name of the new blast database should match the name in the public/constants.js file.&quot;;
  res.send(txt);
});
//
//
//
//  REGULAR FXNS
//

  //
  // GET SEARCH DATASETS
  //
function get_search_datasets(user, search){
    //var datasets_plus = [];
    var datasets = [];
    //var tmp_metadata = {};
    if(HDF5_MDATA == &#039;&#039;){
        
        for (var did in AllMetadata){
          // search only if did allowed by permissions
          var pid = PROJECT_ID_BY_DID[did];
          //console.log(&#039;pid&#039;,pid,&#039;did&#039;,did)
          //console.log(&#039;IN METADATA&#039;,user.security_level,PROJECT_INFORMATION_BY_PID[pid]);
          try{
              
              if(user.security_level === 1 || PROJECT_INFORMATION_BY_PID[pid].permissions.length === 0 || PROJECT_INFORMATION_BY_PID[pid].permissions.indexOf(user.user_id) !=-1 ){
                for (var mdname in AllMetadata[did]){
                  if(mdname === search[&#039;metadata-item&#039;]){
                    mdvalue = AllMetadata[did][mdname];
                    datasets.append(get_search_datasets_did(datasets, search, did, mdname, mdvalue))
                  }
                }
              }
            }
            catch(e){
                console.log(&#039;skipping pid,did&#039;,pid,did,e)
            }
        }
      
    }else{
        for (var did in DATASET_NAME_BY_DID){
          //console.log(&#039;did&#039;,did)
          // search only if did allowed by permissions
          var pid = PROJECT_ID_BY_DID[did];
          try{
              if(user.security_level === 1 || PROJECT_INFORMATION_BY_PID[pid].permissions.length === 0 || PROJECT_INFORMATION_BY_PID[pid].permissions.indexOf(user.user_id) !=-1 ){
                var mdgroup = HDF5_MDATA.openGroup(did+&quot;/metadata&quot;);
                mdgroup.refresh()
                var mdname = search[&#039;metadata-item&#039;]
                if(mdgroup.hasOwnProperty(mdname)){             
                      mdvalue = mdgroup[mdname];
                      datasets.append(get_search_datasets_did(datasets, search, did, mdname, mdvalue))
                }
              }
           }
           catch(e){
                console.log(&#039;skipping pid,did&#039;,pid,did,e)
           }  
        }
                  
    }
    

    //console.log(&#039;ds&#039;,datasets)      
        
    return {datasets:datasets}//, mdv:tmp_metadata};
}
function get_search_datasets_did(datasets, search, did, mdname, mdvalue){
        
        if(search.hasOwnProperty(&#039;comparison&#039;) &amp;&amp; search.comparison === &#039;equal_to&#039;){
            search_value = Number(search[&#039;single-comparison-value&#039;]);
            if( Number(mdvalue) ===  search_value ){
              //console.log(&#039;equal-to: val &#039;+mdname+&#039; - &#039;+mdvalue);
              datasets.push(did);                  
            }
          }else if(search.hasOwnProperty(&#039;comparison&#039;) &amp;&amp; search.comparison === &#039;less_than&#039;){
            search_value = Number(search[&#039;single-comparison-value&#039;]);
            if(Number(mdvalue) &lt;= search_value){
              //console.log(&#039;less_than: val &#039;+mdname+&#039; - &#039;+mdvalue);
              datasets.push(did);                  
            }
          }else if(search.hasOwnProperty(&#039;comparison&#039;) &amp;&amp; search.comparison === &#039;greater_than&#039;){
            console.log(&#039;in gt&#039;)
            search_value = Number(search[&#039;single-comparison-value&#039;]);
            if(Number(mdvalue) &gt;= search_value){
              //console.log(&#039;greater_than: val &#039;+mdname+&#039; - &#039;+mdvalue);
              datasets.push(did);                  
            }
          }else if(search.hasOwnProperty(&#039;comparison&#039;) &amp;&amp; search.comparison === &#039;not_equal_to&#039;){
            search_value = Number(search[&#039;single-comparison-value&#039;]);
            if(Number(mdvalue) !== search_value){
              //console.log(&#039;not_equal_to: val &#039;+mdname+&#039; - &#039;+mdvalue);
              datasets.push(did);                  
            }
          }else if(search.hasOwnProperty(&#039;comparison&#039;) &amp;&amp; search.comparison === &#039;between_range&#039;){
            min_search_value = Number(search[&#039;min-comparison-value&#039;]);
            max_search_value = Number(search[&#039;max-comparison-value&#039;]);
            if(min_search_value &gt; max_search_value){
              var tmp = max_search_value;
              max_search_value = min_search_value;
              min_search_value = tmp;                  
            }
            if(Number(mdvalue) &gt; min_search_value &amp;&amp; Number(mdvalue) &lt; max_search_value){
              //console.log(&#039;outside_range - mdval: &#039;+mdname+&#039; -- &#039;+mdvalue+&#039; search: &#039;+min_search_value + &#039; - &#039;+max_search_value );
              datasets.push(did);                  
            }
          }else if(search.hasOwnProperty(&#039;comparison&#039;) &amp;&amp; search[&#039;comparison&#039;] === &#039;outside_range&#039;){
            min_search_value = Number(search[&#039;min-comparison-value&#039;]);
            max_search_value = Number(search[&#039;max-comparison-value&#039;]);
            if(min_search_value &gt; max_search_value){
              var tmp = max_search_value;
              max_search_value = min_search_value;
              min_search_value = tmp;                  
            }
            if(Number(mdvalue) &lt; min_search_value || Number(mdvalue) &gt; max_search_value){
              //console.log(&#039;outside_range - mdval: &#039;+mdname+&#039; -- &#039;+mdvalue+&#039; search: &#039;+min_search_value + &#039; - &#039;+max_search_value );
              datasets.push(did);
            }
          }else if(&#039;data&#039; in search){
            list = search[&#039;data&#039;];
            if(list.indexOf(mdvalue) != -1){
              //console.log(&#039;DATA: val &#039;+did+&#039; - &#039;+mdname+&#039; - &#039;+mdvalue);
              datasets.push(did);                  
            }
          }else{
            console.log(&#039;Search ERROR&#039;)
          }   
        return datasets        
}
  //
  // GET DATASET SEARCH ORDER
  //
  function get_dataset_search_info(ds, search){
      var ds_plus = [];
      for(var i in ds){
        var did = ds[i];
        var dname = DATASET_NAME_BY_DID[did];
        var pid = PROJECT_ID_BY_DID[did];
        var pname = PROJECT_INFORMATION_BY_PID[pid].project;
        //var ds_req = did+&#039;--&#039;+pname+&#039;--&#039;+dname;
        if(search == {}){
          ds_plus.push({ did:did, dname:dname, pid:pid, pname:pname });
        }else{
          if(HDF5_MDATA == &#039;&#039;){
            ds_plus.push({ did:did, dname:dname, pid:pid, pname:pname, value:AllMetadata[did][search[&quot;metadata-item&quot;]] });
          }else{
            var mdgroup = HDF5_MDATA.openGroup(did+&quot;/metadata&quot;);
            mdgroup.refresh()
            ds_plus.push({ did:did, dname:dname, pid:pid, pname:pname, value:mdgroup[search[&quot;metadata-item&quot;]] });
          }
          
        }
      }
      return ds_plus;
  }

  function IsNumeric(n) {
    return !isNaN(parseFloat(n)) &amp;&amp; isFinite(n);
  }
  function onlyUnique(value, index, self) {
    return self.indexOf(value) === index;
  }
  
  module.exports = router;</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
