<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - routes/visuals/routes_visualization.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>routes/visuals/routes_visualization.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">55.96</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">842</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">75.82</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">8.72</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">var express = require(&#039;express&#039;);
var router = express.Router();

var util = require(&#039;util&#039;);
var url  = require(&#039;url&#039;);
var http = require(&#039;http&#039;);
var path = require(&#039;path&#039;);
var fs   = require(&#039;fs&#039;);
var async = require(&#039;async&#039;);
var nodemailer = require(&#039;nodemailer&#039;);
var transporter = nodemailer.createTransport();
var zlib = require(&#039;zlib&#039;);
var Readable = require(&#039;stream&#039;).Readable;

var helpers = require(&#039;../helpers/helpers&#039;);
var QUERY = require(&#039;../queries&#039;);


var COMMON  = require(&#039;./routes_common&#039;);
var META    = require(&#039;./routes_metadata&#039;);
var PCOA    = require(&#039;./routes_pcoa&#039;);
var MTX     = require(&#039;./routes_counts_matrix&#039;);
var HMAP    = require(&#039;./routes_distance_heatmap&#039;);
var DEND    = require(&#039;./routes_dendrogram&#039;);
var BCHARTS = require(&#039;./routes_bar_charts&#039;);
var PCHARTS = require(&#039;./routes_pie_charts&#039;);
//var CTABLE  = require(&#039;./routes_counts_table&#039;);
var PythonShell = require(&#039;python-shell&#039;);
var app = express();
var d3 = require(&quot;d3&quot;);
var xmldom = require(&#039;xmldom&#039;);
// // init_node var node_class = 
// var CustomTaxa  = require(&#039;./custom_taxa_class&#039;);

/*
 * GET visualization page.
 */
router.post(&#039;/view_selection&#039;, helpers.isLoggedIn, function(req, res) {
  // This page (view_selection) comes after the datasets and units have been selected
  //    in the previous two pages.
  // It should be protected with isLoggedIn like /unit_selection below.
  // The function call will look like this when isLoggedIn is in place:
  //            router.post(&#039;/view_selection&#039;, isLoggedIn, function(req, res) {
  // This page is where the user will choose to view his/her selected visuals.
  // The left side will show a synopsis of what choices the user has made:
  //    datasets, normalization, units and any specifics such as tax rank, domain, NAs ....
  // The middle section will have a list of buttons allowing download of files
  // And the right side will have links to the previously selected visuals.
  // Before this page is rendered the visuals should have been created using the functions called below.
  // The visual pages will be created in a public directory and each page will have a random number or timestamp
  //    attached so the page is private and can be deleted later.
  // TESTING:
  //    There should be one or more datasets shown in list
  //    There should be one or more visual choices shown.
  //
  //var body = JSON.parse(req.body);
  console.log(&#039;req.body: view_selection--&gt;&gt;&#039;);
  console.log(req.body);
  console.log(&#039;req.body: view_selection&#039;);
  //console.log(TaxaCounts[&#039;27&#039;])
  //console.log(&#039;1&#039;);
  
  // GLOBAL Variable
  visual_post_items = COMMON.save_post_items(req);

  var data_source_testing = &#039;json&#039;;   // options: json, db, hdf5
  helpers.start = process.hrtime();
  helpers.elapsed_time(&quot;START: in view_selection using data_source_testing= &quot;+data_source_testing+&quot; --&gt;&gt;&gt;&gt;&gt;&gt;&quot;);
  //
  //
  //
  if(data_source_testing == &#039;json&#039;) {
    // GLOBAL
    var timestamp = +new Date();  // millisecs since the epoch!
    timestamp = req.user.username + &#039;_&#039; + timestamp;
    visual_post_items.ts = timestamp;
    distance_matrix = {};
    biom_matrix = MTX.get_biom_matrix(chosen_id_name_hash, visual_post_items);
    visual_post_items.max_ds_count = biom_matrix.max_dataset_count;
    
    
    // GLOBAL
    console.log(&#039;metadata&#039;);
    metadata = META.write_metadata_file(chosen_id_name_hash, visual_post_items);
    //metadata = JSON.parse(metadata);
    console.log(metadata);
    console.log(&#039;metadata&#039;);
    //console.log(&#039;MAP:::&#039;);
    //console.log(new_taxonomy.taxa_tree_dict_map_by_db_id_n_rank)
    //console.log(new_taxonomy.taxa_tree_dict_map_by_db_id_n_rank[&quot;724_class&quot;][&quot;taxon&quot;])

    //
    //uid_matrix = MTX.fill_in_counts_matrix( selection_obj, unit_field );  // just ids, but filled in zeros
    // {unit_id:[cnt1,cnt2...] // counts are in ds order
    console.log(&#039;visual_post_items:&gt;&gt;&#039;);
    console.log(visual_post_items); 
    console.log(&#039;&lt;&lt;visual_post_items:&#039;);
    //console.log(biom_matrix);        
     
    //req.flash(&#039;info&#039;, &#039;Datasets are updated!&#039;)
    res.render(&#039;visuals/view_selection&#039;, { 
                                  title     :           &#039;VAMPS: Visuals Select&#039;,
                                  chosen_id_name_hash : JSON.stringify(chosen_id_name_hash),
                                  matrix    :           JSON.stringify(biom_matrix),
                                  metadata  :           JSON.stringify(metadata),
                                  constants :           JSON.stringify(req.C),
                                  post_items:           JSON.stringify(visual_post_items),   
                                  user      :           req.user,
                                  messages  : {}
                   });
    helpers.elapsed_time(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 2 After Page Render using data_source_testing= &quot;+data_source_testing+&quot; &lt;&lt;&lt;&lt;&lt;&lt;&quot;); 
  
  }else if(data_source_testing == &#039;db&#039;) {
    var uitems = visual_post_items.unit_choice.split(&#039;_&#039;);
    unit_name_query = QUERY.get_taxonomy_query( req.db, uitems, chosen_id_name_hash, visual_post_items );
    req.db.query(unit_name_query, function(err, rows, fields){
        if (err) {
          throw err;
        } else {   
          

          // GLOBAL
          distance_matrix = {};
          biom_matrix = MTX.get_biom_matrix(chosen_id_name_hash, visual_post_items, rows);
          visual_post_items.max_ds_count = biom_matrix.max_dataset_count;
          metadata = META.write_metadata_file(chosen_id_name_hash, visual_post_items, rows);
          
          res.render(&#039;visuals/view_selection&#039;, { 
                                  title     :           &#039;VAMPS: Visuals Select&#039;,
                                  chosen_id_name_hash : JSON.stringify(chosen_id_name_hash),
                                  matrix    :           JSON.stringify(biom_matrix),
                                  metadata  :           JSON.stringify(metadata),
                                  constants :           JSON.stringify(req.C),
                                  post_items:           JSON.stringify(visual_post_items),          
                                  user      :           req.user,
                                  messages  : {}
                       });
          
        }
        helpers.elapsed_time(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 2 After Page Render using data_source_testing= &quot;+data_source_testing+&quot; &lt;&lt;&lt;&lt;&lt;&lt;&quot;); 
    });
    

  }else if(data_source_testing == &#039;hdf5&#039;) {
    // TODO TODO
  }
  
 
});


// use the isLoggedIn function to limit exposure of each page to
// logged in users only
router.post(&#039;/unit_selection&#039;, helpers.isLoggedIn, function(req, res) {
//router.post(&#039;/unit_selection&#039;,  function(req, res) {
  
  // TESTING:
  //    There should be one or more datasets shown in list
  //    The Submit button should return with an alert error if no display checkboxes are checked
  //    There should be a &#039;default&#039; Units Selection present (This point is debatable -- the other option
  //        would be leave blank and force the user to select). I chose Silva108--Simple Taxonomy as default.
  //    The &#039;Display Output&#039; section should list the items from public/constants.js
  //    The &#039;Normailzation&#039; section should list the items from public/constants.js with the NotNormalized option
  //        checked by default.
  //console.log(&#039;START BODY&gt;&gt; in route/visualization.js /unit_selection&#039;);
  //console.log(JSON.stringify(req.body));
  //console.log(&#039;&lt;&lt;END BODY&#039;);
  console.log(&#039;req.body: unit_selection--&gt;&gt;&#039;);
  console.log(req.body);
  console.log(&#039;req.body: unit_selection&#039;);
  if(req.body.search == &#039;1&#039;){
    dataset_ids = JSON.parse(req.body.dataset_ids);
  }else{
    dataset_ids = req.body.dataset_ids;
  }
  var available_units = req.C.AVAILABLE_UNITS; // [&#039;med_node_id&#039;,&#039;otu_id&#039;,&#039;taxonomy_gg_id&#039;]

  // GLOBAL Variable
  chosen_id_name_hash           = COMMON.create_chosen_id_name_hash(dataset_ids);
  
  var custom_metadata_selection = COMMON.get_custom_meta_selection(chosen_id_name_hash.ids)
  //console.log(&#039;chosen_id_name_hash&#039;)
  //console.log(chosen_id_name_hash)
  // // benchmarking
  // var start = process.hrtime();
  // 
  // // benchmarking
  // var elapsed_time = function(note){
  //     var precision = 3; // 3 decimal places
  //     var elapsed = process.hrtime(start)[1] / 1000000; // divide by a million to get nano to milli
  //     console.log(process.hrtime(start)[0] + &quot; s, &quot; + elapsed.toFixed(precision) + &quot; ms - &quot; + note); // print message + time
  //     //start = process.hrtime(); // reset the timer
  // };

  // benchmarking
  helpers.start = process.hrtime();
  helpers.elapsed_time(&quot;START: select from sequence_pdr_info and sequence_uniq_info--&gt;&gt;&gt;&gt;&gt;&gt;&quot;);
  
  
     
  console.log(&#039;chosen_id_name_hash--&gt;&#039;);
  console.log(chosen_id_name_hash);
  console.log(&#039;&lt;--chosen_id_name_hash&#039;);
    

  res.render(&#039;visuals/unit_selection&#039;, {   
                    title: &#039;VAMPS: Units Selection&#039;,
                    chosen_id_name_hash: JSON.stringify(chosen_id_name_hash),
                    constants    : JSON.stringify(req.C),
                    md_cust      : JSON.stringify(custom_metadata_selection),  // should contain all the cust items that selected datasets have
                    user         : req.user
  });  // end render
    // benchmarking
  helpers.elapsed_time(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 4 After Page Render &lt;&lt;&lt;&lt;&lt;&lt;&quot;);   
   

}); // end fxn

/*
 * GET visualization page.
 */
router.get(&#039;/index_visuals&#039;, helpers.isLoggedIn, function(req, res) {
  // This page is arrived at using GET from the Main Menu
  // It will be protected usind the helpers.isLoggedIn function
  // TESTING:
  //      Should show the closed project list on initialize
  //      The javascript functions (load_project_select, set_check_project, open_datasets, toggle_selected_datasets)
  //        should work to open the project (show and check the datasets) when either the plus image is clicked or the
  //        checkbox is selected. Clicking the minus image should deselect the datasets and close the dataset list.
  //        While the project is open clicking on the project checkbox should toggle all the datasets under it.
  //      Clicking the submit button when no datasets have been selected should result in an alert box and a
  //      return to the page.
  console.log(ALL_DATASETS);
  //console.log(req.user)
  res.render(&#039;visuals/index_visuals&#039;, { 
                                title   : &#039;VAMPS: Select Datasets&#039;,
                                rows    : JSON.stringify(ALL_DATASETS),
                                permissions: JSON.stringify(PROJECT_PERMISSION_BY_PID),
                                constants    : JSON.stringify(req.C),
                                user: req.user
                            });
});
//
//
//
router.post(&#039;/search_datasets&#039;, helpers.isLoggedIn, function(req, res) {
  console.log(&#039;req.body--&gt;&gt;&#039;);
  console.log(req.body);
  console.log(&#039;&lt;&lt;--req.body&#039;);

  var search_function = req.body.search_function;
  var searches = {};
  var allowed = [ &#039;search1&#039;, &#039;search2&#039;, &#039;search3&#039; ];
  if(search_function === &#039;search_metadata_all_datasets&#039;){
    for(name in req.body){  
      items = name.split(&#039;_&#039;);
      var search = items[0];
      if(allowed.indexOf(search) != -1){
        if( !(search  in searches)){
          searches[search] = {};
        }
        searches[search][items[1]] = req.body[name];
      }
    }
  }
  var join_type = req.body.join_type;
  console.log(searches)

  // search datasets
  //console.log(MetadataValues);
  // This assumes that ALL datasets are in MetadataValues. 
  //var datasets = [];
   // use for posting to unit_selection
  //
  //
  
  //
  var ds1, ds2, ds3 = [];
  var result = get_search_datasets(req.user, searches.search1, MetadataValues);
  ds1 = result.datasets
  searches.search1.datasets = result.datasets;
  searches.search1.dataset_count = searches.search1.datasets.length;
  searches.search1.ds_plus = get_dataset_search_info(result.datasets, searches.search1);
  
  
  if(&#039;search2&#039; in searches){
    //if(join_type == &#039;intersect&#039;){
    //  var md_hash = result.mdv
    //}else{  // summation
      var md_hash =  MetadataValues;
    //}
    var result = get_search_datasets(req.user, searches.search2, md_hash);
    ds2 = result.datasets;
    searches.search2.datasets = result.datasets;
    searches.search2.dataset_count = searches.search2.datasets.length;
    //console.log(&#039;result.mdv2&#039;)
    //console.log(result.mdv)
    searches.search2.ds_plus = get_dataset_search_info(result.datasets, searches.search2);

  }
  
  if(&#039;search3&#039; in searches){
    //if(join_type == &#039;intersect&#039;){
    //  var md_hash = result.mdv
    //}else{
      var md_hash =  MetadataValues;
    //}
    var result = get_search_datasets(req.user, searches.search3, md_hash);
    ds3 = result.datasets;
    searches.search3.datasets = result.datasets;
    searches.search3.dataset_count = searches.search3.datasets.length;
    //console.log(&#039;result.mdv3&#039;)
    //console.log(result.mdv)
    searches.search3.ds_plus = get_dataset_search_info(result.datasets, searches.search3);
  }
  //
  // Calculate (sum or intersect) final datasets
  //
  var filtered = {};
  if(join_type == &#039;combination&#039;){
    filtered.datasets = ds1.concat(ds2, ds3);
    filtered.datasets = filtered.datasets.filter(onlyUnique);
  }else{   // intersection
    filtered.datasets = ds1;
    if(&#039;search2&#039; in searches) { 
      filtered.datasets = ds1.filter(function(n) {
          return ds2.indexOf(n) != -1
      });
    }
    if(&#039;search3&#039; in searches) { 
      filtered.datasets = filtered.datasets.filter(function(n) {
          return ds3.indexOf(n) != -1
      });
    }
  }
  filtered.ds_plus = get_dataset_search_info(filtered.datasets, {});
  //
  //
  //searches.search1.dataset_count = ds.dataset_ids.length;
  
  
  console.log(&#039;searches&#039;)
  console.log(searches)
  
  console.log(&#039;final&#039;);
  console.log(filtered.datasets);
  //searches.dataset_count = result.datasets.length;
  
//  { dataset_ids:
//   [ &#039;142--BPC_1V2STP_Bv4v5--SLM_NIH_19SS_rep1_1Step&#039;,
//     &#039;146--BPC_1V2STP_Bv4v5--SLM_NIH_19SS_rep1_2Step&#039; ],
//   }
  
  //if(ds.dataset_ids.length != 0){
  // if((&#039;data&#039; in searches.search1 &amp;&amp; searches.search1[&#039;data&#039;].length &gt; 0) || 
  //    (&#039;single-comparison-value&#039; in searches.search1 &amp;&amp; searches.search1[&#039;single-comparison-value&#039;] != &#039;&#039;)  || 
  //    ((&#039;min-comparison-value&#039;   in searches.search1 &amp;&amp; searches.search1[&#039;min-comparison-value&#039;]    != &#039;&#039;) &amp;&amp;
  //     (&#039;max-comparison-value&#039;   in searches.search1 &amp;&amp; searches.search1[&#039;max-comparison-value&#039;]    != &#039;&#039;))
  //     ){
  //if(!(&#039;single-comparison-value&#039; in searches.search1)){
          res.render(&#039;visuals/search_datasets&#039;, {   
                    title    : &#039;VAMPS: Search Datasets&#039;,
                    filtered : JSON.stringify(filtered),
                    searches : JSON.stringify(searches),
                    join_type: join_type,
                    //dids     : JSON.stringify(result.datasets),
                    user     : req.user
          });  // 
  //}else{
  //  console.log(&#039;no data selected or entered&#039;)
  //}

});
//
//
//
router.get(&#039;/reorder_datasets&#039;, helpers.isLoggedIn, function(req, res) {
  
  res.render(&#039;visuals/reorder_datasets&#039;, { 
                                title   : &#039;VAMPS: Reorder Datasets&#039;,
                                chosen_id_name_hash: JSON.stringify(chosen_id_name_hash),
                                constants    : JSON.stringify(req.C),
                                user: req.user
                            });
  //console.log(chosen_id_name_hash)
});





router.post(&#039;/heatmap&#039;, function(req, res) {
    //console.log(&#039;found routes_test_heatmap&#039;)
    //console.log(&#039;req.body hm&#039;);
    //console.log(req.body);
    //console.log(&#039;req.body hm&#039;);
    var ts = req.body.ts
    var metric = req.body.metric;
    var biom_file_name = ts+&#039;_count_matrix.biom&#039;;
    var biom_file = path.join(__dirname, &#039;../../tmp/&#039;+biom_file_name);
    
    //console.log(&#039;mtx1&#039;)
  
  //mtx = COMMON.run_pyscript_cmd(req,res, ts, biom_file, &#039;heatmap&#039;, metric);
    var exec = require(&#039;child_process&#039;).exec;
    //var PythonShell = require(&#039;python-shell&#039;);
    var html = &#039;&#039;;
    var title = &#039;VAMPS&#039;;
    
    var distmtx_file_name = ts+&#039;_distance.csv&#039;
    var distmtx_file = path.join(__dirname, &#039;../../tmp/&#039;+distmtx_file_name);
    var site_base = path.join(__dirname, &#039;../../&#039;);
    var options = {
      scriptPath : &#039;public/scripts&#039;,
      args :       [ &#039;-in&#039;, biom_file, &#039;-metric&#039;, metric, &#039;--function&#039;, &#039;dheatmap&#039;, &#039;--site_base&#039;, site_base, &#039;--prefix&#039;, ts], 
    };
    console.log(options.scriptPath+&#039;/distance.py &#039;+options.args.join(&#039; &#039;))
    PythonShell.run(&#039;distance.py&#039;, options, function (err, mtx) {
      if (err) throw err;
      distance_matrix = JSON.parse(mtx);
      console.log(&#039;dmtx&#039;)
      console.log(distance_matrix)
      var m = JSON.stringify(mtx)
      res.render(&#039;visuals/partials/load_distance&#039;,{
                                        dm        : distance_matrix,
                                        constants : JSON.stringify(req.C),
                                      })
      
    });

});

//
//   F R E Q U E N C Y  H E A T M A P
//
router.post(&#039;/frequency_heatmap&#039;, function(req, res) {
  
  console.log(&#039;in Freq HP&#039;)
  var ts = req.body.ts
  var metric = req.body.metric;
  var biom_file_name = ts+&#039;_count_matrix.biom&#039;;
  var biom_file = path.join(__dirname, &#039;../../tmp/&#039;+biom_file_name);
    
  var exec = require(&#039;child_process&#039;).exec;
  //var PythonShell = require(&#039;python-shell&#039;);
  var html = &#039;&#039;;
  var title = &#039;VAMPS&#039;;
    
  var distmtx_file_name = ts+&#039;_distance.csv&#039;
  var distmtx_file = path.join(__dirname, &#039;../../tmp/&#039;+distmtx_file_name);
  var site_base = path.join(__dirname, &#039;../../&#039;);
  
  var fheatmap_script_file = path.resolve(__dirname, &#039;../../public/scripts/fheatmap.R&#039;);

  shell_command = [req.C.RSCRIPT_CMD, fheatmap_script_file, biom_file, visual_post_items.selected_distance, visual_post_items.tax_depth, ts ].join(&#039; &#039;);
     
  COMMON.run_script_cmd(req, res, ts, shell_command, &#039;fheatmap&#039;);
      

});
router.post(&#039;/dendrogram&#039;, function(req, res) {
    console.log(&#039;found routes_dendrogram&#039;)
    
    //console.log(&#039;req.body dnd&#039;);
    //console.log(req.body);
    //console.log(&#039;req.body dnd&#039;);
    var ts = req.body.ts
    var metric = req.body.metric;
    var image_type = req.body.image_type;
    var biom_file_name = ts+&#039;_count_matrix.biom&#039;;
    var biom_file = path.join(__dirname, &#039;../../tmp/&#039;+biom_file_name);
    
   
    var exec = require(&#039;child_process&#039;).exec;
    //var PythonShell = require(&#039;python-shell&#039;);
    var html = &#039;&#039;;
    var title = &#039;VAMPS&#039;;
    
    var distmtx_file_name = ts+&#039;_distance.csv&#039;
    var distmtx_file = path.join(__dirname, &#039;../../tmp/&#039;+distmtx_file_name);
    var site_base = path.join(__dirname, &#039;../../&#039;);
    
    var options = {
      scriptPath : &#039;public/scripts&#039;,
      args :       [ &#039;-in&#039;, biom_file, &#039;-metric&#039;, metric, &#039;--function&#039;, &#039;dendrogram-&#039;+image_type, &#039;--site_base&#039;, site_base, &#039;--prefix&#039;, ts ], 
    };
    console.log(options.scriptPath+&#039;/distance.py &#039;+options.args.join(&#039; &#039;))
    
    PythonShell.run(&#039;distance.py&#039;, options, function (err, output) {
      if (err) throw err;
      
      //var m = JSON.stringify(mtx)
      if(image_type == &#039;svg&#039;){
        //console.log(JSON.parse(output))
        var d3 = require(&quot;d3&quot;);
        var xmldom = require(&#039;xmldom&#039;);
        var Newick    = require(&#039;../../public/javascripts/newick&#039;);
        var Phylogram = require(&#039;../../public/javascripts/d3.phylogram&#039;);
        newick = JSON.parse(output);
        //console.log(&#039;Newick &#039;,newick)
        var json  = Newick.parse(newick);
        //console.log(JSON.stringify(json,null,4))
        var newickNodes = [];
        function buildNewickNodes(node, callback) {
          newickNodes.push(node);
          if (node.branchset) {
            for (var i=0; i &lt; node.branchset.length; i++) {
              buildNewickNodes(node.branchset[i]);
            }
          }
        }
        buildNewickNodes(json);
		
        var tree_data = d3.phylogram.build(&#039;body&#039;, json, {
          width: 300,
          height: visual_post_items.no_of_datasets*100
        });
		
        var svgXML = (new xmldom.XMLSerializer()).serializeToString( tree_data.vis[0][0] );
		
        var html = &quot;&lt;svg height=&#039;&quot;+(visual_post_items.no_of_datasets*100)+&quot;&#039; width=&#039;900&#039;&gt;&quot;+svgXML+&quot;&lt;/svg&gt;&quot;;
         
        d3.select(&#039;svg&#039;).remove(); 
        
        //console.log(html);
        
      }else{

         var image = &#039;/tmp_images/&#039;+ts+&#039;_dendrogram.pdf&#039;
            var html = &quot;&lt;div id=&#039;pdf&#039;&gt;&quot;;
            html += &quot;&lt;object data=&#039;&quot;+image+&quot;?zoom=100&amp;scrollbar=0&amp;toolbar=0&amp;navpanes=0&#039; type=&#039;application/pdf&#039; width=&#039;1000&#039; height=&#039;900&#039; /&gt;&quot;;
            html += &quot; &lt;p&gt;ERROR in loading pdf file&lt;/p&gt;&quot;;
            html += &quot;&lt;/object&gt;&lt;/div&gt;&quot;
      }
      res.send(html);
      

    });

});
//
// P I E C H A R T  -- S I N G L E
//
router.get(&#039;/user_data/piechart_single&#039;, function(req, res) {
    var myurl = url.parse(req.url, true);
    //console.log(myurl)
    var ts = myurl.query.ts;
    var ds_name = myurl.query.ds;
    var html  = COMMON.start_visuals_html(&#039;piechart&#039;);
    
    html += PCHARTS.create_single_piechart_html ( ts, ds_name, res );

    res.render(&#039;visuals/user_data/piechart_single&#039;, {
          title: &#039;VAMPS Single PieChart:&#039;,
          subtitle: ds_name,
          timestamp: ts || &#039;default_timestamp&#039;,
          dataset: ds_name,
          html: html,
          user: req.user
        });

});





 // P C O A

router.post(&#039;/pcoa&#039;, function(req, res) {
    console.log(&#039;in PCoA&#039;)
    console.log(metadata)
    var ts = req.body.ts
    var metric = req.body.metric;
    var biom_file_name = ts+&#039;_count_matrix.biom&#039;;
    var biom_file = path.join(__dirname, &#039;../../tmp/&#039;+biom_file_name);
    var site_base = path.join(__dirname, &#039;../../&#039;);
    var exec = require(&#039;child_process&#039;).exec;
    var options = {
      scriptPath : &#039;public/scripts&#039;,
      args :       [ &#039;-in&#039;, biom_file, &#039;-metric&#039;, metric, &#039;--function&#039;, &#039;pcoa&#039;, &#039;--site_base&#039;, site_base, &#039;--prefix&#039;, ts], 
    };
    console.log(options.scriptPath+&#039;/distance.py &#039;+options.args.join(&#039; &#039;))
    PythonShell.run(&#039;distance.py&#039;, options, function (err, pcoa_data) {
      if (err) throw err;
      //console.log(pcoa_data)
      //pcoa_data = JSON.parse(pcoa_data)
      //console.log(pcoa_data); 

      var image = &#039;/tmp_images/&#039;+ts+&#039;_pcoa.pdf&#039;
      var html = &quot;&lt;div id=&#039;pdf&#039;&gt;&quot;;
      html += &quot;&lt;object data=&#039;&quot;+image+&quot;?zoom=100&amp;scrollbar=0&amp;toolbar=0&amp;navpanes=0&#039; type=&#039;application/pdf&#039; width=&#039;1000&#039; height=&#039;900&#039; /&gt;&quot;;
      html += &quot; &lt;p&gt;ERROR in loading pdf file&lt;/p&gt;&quot;;
      html += &quot;&lt;/object&gt;&lt;/div&gt;&quot;
      console.log(html)
      res.send(html);


      
    });    

});


//
//  G E O S P A T I A L
//
router.get(&#039;/user_data/geospatial&#039;, function(req, res) {
  var myurl = url.parse(req.url, true);
  
  var ts    = myurl.query.ts;
  var html  = COMMON.start_visuals_html(&#039;geospatial&#039;);
  
  res.render(&#039;visuals/user_data/geospatial&#039;, {
            title: &#039;VAMPS Geospatial Data&#039;,
            timestamp: ts || &#039;default_timestamp&#039;,
            html : html+&quot;&lt;h2&gt;Not Coded Yet&lt;/h2&gt;&quot;,
            user: req.user
      });
 

});
router.get(&#039;/user_data/test_page&#039;, function(req, res) {
  
  res.render(&#039;visuals/user_data/test_page&#039;, {
            title: &#039;VAMPS TEST&#039;,
            
      });
 

});
/*
*   PARTIALS
*      These six partials all belong to the unit_selection page
*      and are shown via ajax depending on user selection in combo box
*       on that page.  AAV
*/
router.get(&#039;/partials/tax_silva108_simple&#039;,  function(req, res) {
    res.render(&#039;visuals/partials/tax_silva108_simple&#039;, {
        doms: req.C.DOMAINS
    });
});
//
//
//

// benchmarking
// var start = process.hrtime();
// 
// var elapsed_time = function(note){
//     var precision = 3; // 3 decimal places
//     var elapsed = process.hrtime(start)[1] / 1000000; // divide by a million to get nano to milli
//     console.log(process.hrtime(start)[0] + &quot; s, &quot; + elapsed.toFixed(precision) + &quot; ms - &quot; + note); // print message + time
//     start = process.hrtime(); // reset the timer
// };
router.get(&#039;/partials/load_metadata&#039;,  function(req, res) {
  var myurl = url.parse(req.url, true);
  var load = myurl.query.load  || &#039;all&#039;   // either &#039;all&#039; or &#039;selected&#039;
  res.render(&#039;visuals/partials/load_metadata&#039;, 
    { title   : &#039;metadata_table&#039;,
      load    : load
    });
});
router.get(&#039;/partials/tax_silva108_custom&#039;,  function(req, res) {
  res.render(&#039;visuals/partials/tax_silva108_custom&#039;, 
    { title   : &#039;Silva(v108) Custom Taxonomy Selection&#039;});
});

router.get(&#039;/partials/tax_gg_custom&#039;,  function(req, res) {
    res.render(&#039;visuals/partials/tax_gg_custom&#039;,{});
});
router.get(&#039;/partials/tax_gg_simple&#039;,  function(req, res) {
    res.render(&#039;visuals/partials/tax_gg_simple&#039;,{});
});
router.get(&#039;/partials/otus&#039;,  function(req, res) {
    res.render(&#039;visuals/partials/otus&#039;,{});
});
router.get(&#039;/partials/med_nodes&#039;,  function(req, res) {
    res.render(&#039;visuals/partials/med_nodes&#039;,{});
});



module.exports = router;

/**
* F U N C T I O N S
*/

function IsJsonString(str) {
    try {
        JSON.parse(str);
    } catch (e) {
        return false;
    }
    return true;
}
//
function onlyUnique(value, index, self) { 
    return self.indexOf(value) === index;
}
//
function get_search_datasets(user, search, metadata){
  //var datasets_plus = [];
  var datasets = [];  // use for posting to unit_selection
  var tmp_metadata = {};
  for(did in metadata){
    
    // search only if did allowed by permissions
    var pid = PROJECT_ID_BY_DID[did];
    if(user.security_level === 1 || PROJECT_PERMISSION_BY_PID[pid]  === 0 || PROJECT_PERMISSION_BY_PID[pid] === user.user_id ){
      console.log(&#039;IN METADATA&#039;)
      for(mdname in metadata[did]){
        if(mdname === search[&#039;metadata-item&#039;]){
          
          mdvalue = metadata[did][mdname];
            
          if((&#039;comparison&#039; in search) &amp;&amp; (search[&#039;comparison&#039;] === &#039;equal_to&#039;)){
            search_value = Number(search[&#039;single-comparison-value&#039;]);
            if( Number(mdvalue) ===  search_value ){
              console.log(&#039;equal-to: val &#039;+mdname+&#039; - &#039;+mdvalue)
              datasets.push(did);
              //datasets_plus.push({did:did,dname:dname,pid:pid,pname:pname});
              //ds.dataset_ids.push(ds_req);
              if(did in tmp_metadata){
                tmp_metadata[did] = metadata[did];
              }else{
                tmp_metadata[did]={};
                tmp_metadata[did] = metadata[did];
              }
            }
          }else if(&#039;comparison&#039; in search &amp;&amp; search[&#039;comparison&#039;] === &#039;less_than&#039;){
            search_value = Number(search[&#039;single-comparison-value&#039;]);
            if(Number(mdvalue) &lt;= search_value){
              console.log(&#039;less_than: val &#039;+mdname+&#039; - &#039;+mdvalue)
              datasets.push(did);
              //datasets_plus.push({did:did,dname:dname,pid:pid,pname:pname});
              //ds.dataset_ids.push(ds_req);
              if(did in tmp_metadata){
                tmp_metadata[did] = metadata[did];
              }else{
                tmp_metadata[did]={};
                tmp_metadata[did] = metadata[did];
              }
            }
          }else if(&#039;comparison&#039; in search &amp;&amp; search[&#039;comparison&#039;] === &#039;greater_than&#039;){
            search_value = Number(search[&#039;single-comparison-value&#039;]);
            if(Number(mdvalue) &gt;= search_value){
              console.log(&#039;greater_than: val &#039;+mdname+&#039; - &#039;+mdvalue);
              datasets.push(did);
              //datasets_plus.push({did:did,dname:dname,pid:pid,pname:pname});
              //ds.dataset_ids.push(ds_req);
              if(did in tmp_metadata){
                tmp_metadata[did] = metadata[did];
              }else{
                tmp_metadata[did]={};
                tmp_metadata[did] = metadata[did];
              }
            }
          }else if(&#039;comparison&#039; in search &amp;&amp; search[&#039;comparison&#039;] === &#039;not_equal_to&#039;){
            search_value = Number(search[&#039;single-comparison-value&#039;]);
            if(Number(mdvalue) !== search_value){
              console.log(&#039;not_equal_to: val &#039;+mdname+&#039; - &#039;+mdvalue);
              datasets.push(did);
              //datasets_plus.push({did:did,dname:dname,pid:pid,pname:pname});
              //ds.dataset_ids.push(ds_req);
              if(did in tmp_metadata){
                tmp_metadata[did] = metadata[did];
              }else{
                tmp_metadata[did]={};
                tmp_metadata[did] = metadata[did];
              }
            }
          }else if(&#039;comparison&#039; in search &amp;&amp; search[&#039;comparison&#039;] === &#039;between_range&#039;){
            min_search_value = Number(search[&#039;min-comparison-value&#039;]);
            max_search_value = Number(search[&#039;max-comparison-value&#039;]);
            if(Number(mdvalue) &gt; min_search_value &amp;&amp; Number(mdvalue) &lt; max_search_value){
              console.log(&#039;outside_range - mdval: &#039;+mdname+&#039; -- &#039;+mdvalue+&#039; search: &#039;+min_search_value + &#039; - &#039;+max_search_value );
              datasets.push(did);
              //datasets_plus.push({did:did,dname:dname,pid:pid,pname:pname});
              //ds.dataset_ids.push(ds_req);
              if(did in tmp_metadata){
                tmp_metadata[did] = metadata[did];
              }else{
                tmp_metadata[did]={};
                tmp_metadata[did] = metadata[did];
              }
            }

          }else if(&#039;comparison&#039; in search &amp;&amp; search[&#039;comparison&#039;] === &#039;outside_range&#039;){
            min_search_value = Number(search[&#039;min-comparison-value&#039;]);
            max_search_value = Number(search[&#039;max-comparison-value&#039;]);
            if(Number(mdvalue) &lt; min_search_value || Number(mdvalue) &gt; max_search_value){
              console.log(&#039;outside_range - mdval: &#039;+mdname+&#039; -- &#039;+mdvalue+&#039; search: &#039;+min_search_value + &#039; - &#039;+max_search_value );
              datasets.push(did);
              //datasets_plus.push({did:did,dname:dname,pid:pid,pname:pname});
              //ds.dataset_ids.push(ds_req);
              if(did in tmp_metadata){
                tmp_metadata[did] = metadata[did];
              }else{
                tmp_metadata[did]={};
                tmp_metadata[did] = metadata[did];
              }
            }

          }else if(&#039;data&#039; in search){
            list = search[&#039;data&#039;]
            if(list.indexOf(mdvalue) != -1){
              console.log(&#039;DATA: val &#039;+did+&#039; - &#039;+mdname+&#039; - &#039;+mdvalue);
              datasets.push(did);
              //datasets_plus.push({did:did,dname:dname,pid:pid,pname:pname});
              //ds.dataset_ids.push(ds_req);
              if(did in tmp_metadata){
                tmp_metadata[did] = metadata[did];
              }else{
                tmp_metadata[did]={};
                tmp_metadata[did] = metadata[did];
              }
            }
          }
        }
      }
    }
  }
  return {datasets:datasets, mdv:tmp_metadata};
}
function get_dataset_search_info(ds, search){
    var ds_plus = [];
    for(var i in ds){
      var did = ds[i];
      var dname = DATASET_NAME_BY_DID[did];
      var pid = PROJECT_ID_BY_DID[did];
      var pname = PROJECT_INFORMATION_BY_PID[pid].project
      //var ds_req = did+&#039;--&#039;+pname+&#039;--&#039;+dname;
      if(search == {}){
        ds_plus.push({ did:did, dname:dname, pid:pid, pname:pname });
      }else{
        ds_plus.push({ did:did, dname:dname, pid:pid, pname:pname, value:MetadataValues[did][search[&quot;metadata-item&quot;]] });
      }
    }
    return ds_plus;
}

//
//
//</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
