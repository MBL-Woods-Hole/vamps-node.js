<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - routes/visuals/routes_visualization.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>routes/visuals/routes_visualization.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">59.93</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">719</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">59.29</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">6.56</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">var express = require(&#039;express&#039;);
var router = express.Router();

var util = require(&#039;util&#039;);
var url  = require(&#039;url&#039;);
var http = require(&#039;http&#039;);
var path = require(&#039;path&#039;);
var fs   = require(&#039;fs&#039;);
var async = require(&#039;async&#039;);


var helpers = require(&#039;../helpers/helpers&#039;);

var COMMON  = require(&#039;./routes_common&#039;);
var META    = require(&#039;./routes_metadata&#039;);
var MTX     = require(&#039;./routes_counts_matrix&#039;);
var HMAP    = require(&#039;./routes_distance_heatmap&#039;);
var DEND    = require(&#039;./routes_dendrogram&#039;);
var BCHARTS = require(&#039;./routes_bar_charts&#039;);
var PCHARTS = require(&#039;./routes_pie_charts&#039;);
//var CTABLE  = require(&#039;./routes_counts_table&#039;);

var app = express();

// // init_node var node_class = 
// var CustomTaxa  = require(&#039;./custom_taxa_class&#039;);

/*
 * GET visualization page.
 */
router.post(&#039;/view_selection&#039;,  function(req, res) {
  // This page (view_selection) comes after the datasets and units have been selected
  //    in the previous two pages.
  // It should be protected with isLoggedIn like /unit_selection below.
  // The function call will look like this when isLoggedIn is in place:
  //            router.post(&#039;/view_selection&#039;, isLoggedIn, function(req, res) {
  // This page is where the user will choose to view his/her selected visuals.
  // The left side will show a synopsis of what choices the user has made:
  //    datasets, normalization, units and any specifics such as tax rank, domain, NAs ....
  // The middle section will have a list of buttons allowing download of files
  // And the right side will have links to the previously selected visuals.
  // Before this page is rendered the visuals should have been created using the functions called below.
  // The visual pages will be created in a public directory and each page will have a random number or timestamp
  //    attached so the page is private and can be deleted later.
  // TESTING:
  //    There should be one or more datasets shown in list
  //    There should be one or more visual choices shown.
  //
  //var body = JSON.parse(req.body);
  console.log(&#039;req.body&#039;);
  console.log(req.body);
  console.log(&#039;req.body&#039;);
  //console.log(&#039;1&#039;);
  //req.body.selection_obj       = JSON.parse(req.body.selection_obj);
  
  //req.body.chosen_id_name_hash = JSON.parse(req.body.chosen_id_name_hash);
  //console.log(&#039;2&#039;);
  
  var visual_post_items = {};
  GLOBAL.visual_post_items = visual_post_items;
  visual_post_items.unit_choice                  = req.body.unit_choice;
  //visual_post_items.max_ds_count                 = COMMON.get_max_dataset_count(selection_obj);
  visual_post_items.no_of_datasets               = chosen_id_name_hash.ids.length;
  visual_post_items.normalization                = req.body.normalization || &#039;none&#039;;
  visual_post_items.visuals                      = req.body.visuals;
  visual_post_items.selected_distance            = req.body.selected_distance || &#039;morisita_horn&#039;;
  visual_post_items.tax_depth                    = req.body.tax_depth    || &#039;custom&#039;;
  visual_post_items.domains                      = req.body.domains      || &#039;all&#039;;
  visual_post_items.include_nas                  = req.body.include_nas  || &#039;yes&#039;;
  visual_post_items.min_range                    = 0;
  visual_post_items.max_range                    = 100;
  visual_post_items.metadata                     = req.body.metadata  || [];

  var sample_metadata = req.C.sample_metadata;
  
  var uitems = visual_post_items.unit_choice.split(&#039;_&#039;);
  var unit_name_query = &#039;&#039;;
  var unit_field;
  if (uitems[0] === &#039;tax&#039;){  // covers both simple and custom

    unit_field = &#039;silva_taxonomy_info_per_seq_id&#039;;
    unit_name_query = COMMON.get_taxonomy_query( req.db, uitems, chosen_id_name_hash, visual_post_items );

  }else if(uitems[0] === &#039;otus&#039;) {
    unit_field = &#039;gg_otu_id&#039;;
    //unit_name_query = COMMON.get_otus_query( req.db, uitems, selection_obj, visual_post_items );
  }else if(uitems[0] === &#039;med_nodes&#039;) {
    unit_field = &#039;med_node_id&#039;;
    //unit_name_query = COMMON.get_med_query( req.db, uitems, selection_obj, visual_post_items );
  }else{
    console.log(&#039;ERROR--RORRE&#039;);
  }
  //console.log(&#039;MAP:::&#039;);
  //console.log(new_taxonomy.taxa_tree_dict_map_by_db_id_n_rank)
  //console.log(new_taxonomy.taxa_tree_dict_map_by_db_id_n_rank[&quot;724_class&quot;][&quot;taxon&quot;])

  //
  //uid_matrix = MTX.fill_in_counts_matrix( selection_obj, unit_field );  // just ids, but filled in zeros
  // {unit_id:[cnt1,cnt2...] // counts are in ds order
   console.log(visual_post_items);
  
  // Get matrix data here
  // The visuals have been selected so now we need to create them
  // so they can be shown fast when selected
  //console.log(JSON.stringify(selection_obj));
  req.db.query(unit_name_query, function(err, rows, fields){
    if (err) {
      throw err;
    } else {   
      var timestamp = +new Date();  // millisecs since the epoch!
      var user = req.user || &#039;no-user&#039;;
      timestamp = user + &#039;_&#039; + timestamp;
      visual_post_items.ts = timestamp;

      // this function: output_matrix writes various counts matrices to files for *possible* use later by R or D3
      // It also reurns a JSON count_matrix
      //count_matrix = MTX.output_matrix( &#039;to_file_and_console&#039;, timestamp, selection_obj, chosen_id_name_hash, rows );   // matrix to have names of datasets and units for display  -- not ids
      


      biome_matrix = MTX.get_biome_matrix(chosen_id_name_hash, visual_post_items, rows);
      visual_post_items.max_ds_count = biome_matrix.max_dataset_count;
      metadata = META.write_metadata_file(chosen_id_name_hash, visual_post_items, rows)
      console.log(biome_matrix);

      // This is what matrix looks like (a different matrix is written to file)
      // { 
      //  dataset_names: 
      //    [ &#039;SLM_NIH_Bv4v5--03_Junction_City_East&#039;,
      //      &#039;SLM_NIH_Bv4v5--02_Spencer&#039;,
      //      &#039;SLM_NIH_Bv4v5--01_Boonville&#039; 
      //    ],
      //  unit_names: 
      //    { &#039;Bacteria;Proteobacteria&#039;: [ 4, 2, 4 ],
      //      &#039;Bacteria;Bacteroidetes&#039;: [ 272, 401, 430 ] 
      //    } 
      //  }

      //req.body.matrix = JSON.stringify(matrix);
      //console.log(&#039;CM&#039;)
      //console.log(JSON.stringify(count_matrix));
      //console.warn(util.inspect(matrix));
      //console.log(dataset_accumulator)
      
     
     
      res.render(&#039;visuals/view_selection&#039;, { 
                                  title   : &#039;VAMPS: Visuals Select&#039;,
                                  chosen_id_name_hash : JSON.stringify(chosen_id_name_hash),
                                  matrix :              JSON.stringify(biome_matrix),
                                  constants :           JSON.stringify(req.C),
                                  timestamp :           timestamp,           // for creating unique files/pages                            
                                  user   :              req.user
                   });
    
    }
  });
 
 
});

// use the isLoggedIn function to limit exposure of each page to
// logged in users only
//router.post(&#039;/unit_selection&#039;, isLoggedIn, function(req, res) {
router.post(&#039;/unit_selection&#039;,  function(req, res) {
  // This page (unit_selection) comes after the datasets have been selected
  // it should only be reached by POST from the previous index_visuals page.
  // It should be protected by the isLoggedIn function (below).
  // Currently I have removed the isLoggedIn function from the function call
  // because the program is easier to test without it (you don&#039;t have to be logged in)
  // This function call will look like this when in place:
  //            router.post(&#039;/unit_selection&#039;, helpers.isLoggedIn, function(req, res) {
  // The logic here is from the selected datasets to create an object that
  // holds the datasetIDs in a certain order. The object also holds the sequence_ids,sequence_counts
  // for each dataset in the same order. The associated unitIDs are also in the object in the same order&gt;
  // {
  //  dataset_ids:[&quot;122&quot;,&quot;136&quot;,&quot;162&quot;],
  //  seq_ids: [ [1002,1004,1005], [1002,1004,1005], [1002,1005,1007] ],
  //  seq_freqs: [ [94,4,178], [32,1,89], [625,1024,2] ],
  //  unit_assoc: {
  //          &quot;tax_silva108_id&quot;: [ [214,82,214], [214,82,214], [214,214,137] ],
  //          &quot;tax_gg_id&quot;:[ [null,null,null], [null,null,null], [null,null,null] ],
  //          &quot;med_node_id&quot;:[ [null,null,null], [null,null,null], [null,null,null] ],
  //          &quot;otu_id&quot;:[ [null,null,null], [null,null,null], [null,null,null] ]
  //          }
  // }
  // I use the GLOBAL keyword below to make this object a global variable:
  // selection_obj  &lt;-- this is the main object containg the IDs
  // Question: can I attach this to the post variable (req.body) or do I need it as GLOBAL?
  //        Currently it is both
  // TESTING:
  //    There should be one or more datasets shown in list
  //    The Submit button should return with an alert error if no display checkboxes are checked
  //    There should be a &#039;default&#039; Units Selection present (This point is debatable -- the other option
  //        would be leave blank and force the user to select). I chose Silva108--Simple Taxonomy as default.
  //    The &#039;Display Output&#039; section should list the items from public/constants.js
  //    The &#039;Normailzation&#039; section should list the items from public/constants.js with the NotNormalized option
  //        checked by default.
  //console.log(&#039;START BODY&gt;&gt; in route/visualization.js /unit_selection&#039;);
  //console.log(JSON.stringify(req.body));
  //console.log(&#039;&lt;&lt;END BODY&#039;);
  var db = req.db;
  var dsets = {};
  var selection_obj = {
    dataset_ids : [],
    //seq_ids     : [],
    seq_freqs   : [],
    unit_assoc  : {}
  };
  var accumulator = {
    dataset_ids : [],
    //seq_ids     : [],
    seq_freqs   : [],
    unit_assoc  : {}
  };

  var available_units = req.C.AVAILABLE_UNITS; // [&#039;med_node_id&#039;,&#039;otu_id&#039;,&#039;taxonomy_gg_id&#039;]

  //for (var i=0; i &lt; available_units.length; i++){
  //  accumulator.unit_assoc[available_units[i]]=[];
  //}


  // dataset selection +/- is checked in routes/visualization.js: check_for_no_datasets()
  //console.log(req.body);
  var chosen_id_name_hash    = {};
  chosen_id_name_hash.ids    = [];
  chosen_id_name_hash.names  = [];
  //console.log(&#039;req.body.dataset_ids&#039;)
  //console.log(req.body.dataset_ids)
  for (var n=0; n &lt; req.body.dataset_ids.length; n++){
    var items = req.body.dataset_ids[n].split(&#039;--&#039;);
    chosen_id_name_hash.ids.push(items[0]);
    chosen_id_name_hash.names.push(items[1]+&#039;--&#039;+items[2]);
  }
  //console.log(&#039;chosen_id_name_hash&#039;)
  //console.log(chosen_id_name_hash)
  // // benchmarking
  // var start = process.hrtime();
  // 
  // // benchmarking
  // var elapsed_time = function(note){
  //     var precision = 3; // 3 decimal places
  //     var elapsed = process.hrtime(start)[1] / 1000000; // divide by a million to get nano to milli
  //     console.log(process.hrtime(start)[0] + &quot; s, &quot; + elapsed.toFixed(precision) + &quot; ms - &quot; + note); // print message + time
  //     //start = process.hrtime(); // reset the timer
  // };

  // benchmarking
  helpers.start = process.hrtime();
  helpers.elapsed_time(&quot;START: select from sequence_pdr_info and sequence_uniq_info--&gt;&gt;&gt;&gt;&gt;&gt;&quot;);
  
  
  var metadata_names = [&#039;patientID&#039;,  &#039;sample_location&#039;, &#039;temperature&#039;,
                      &#039;diss_oxygen&#039;, &#039;ammonium&#039;,  &#039;chlorophyll&#039;,
                      &#039;latitude&#039;, &#039;longitude&#039;, &#039;description&#039;, &#039;body_site&#039;, 
                      &#039;collection_date&#039;, &#039;sample_size&#039;, &#039;study_center&#039;,
                      &#039;meta_10&#039;,&#039;meta_11&#039;,&#039;meta_12&#039;,&#039;meta_13&#039;,&#039;meta_14&#039;,
                      &#039;meta_15&#039;,&#039;meta_16&#039;,&#039;meta_17&#039;  ];
   
//    GLOBAL.selection_obj = accumulator;

    GLOBAL.chosen_id_name_hash = chosen_id_name_hash;
    console.log(&#039;selection_obj--&gt;&#039;);
    //console.log(JSON.stringify(accumulator));
    console.log(&#039;&lt;--selection_obj&#039;);
    console.log(&#039;chosen_id_name_hash--&gt;&#039;);
    //console.log(chosen_id_name_hash);
    console.log(&#039;&lt;--chosen_id_name_hash&#039;);
    helpers.elapsed_time(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 3 Before Page Render But after Query/Calc &lt;&lt;&lt;&lt;&lt;&lt;&quot;);
 

    res.render(&#039;visuals/unit_selection&#039;, {   
                    title: &#039;VAMPS: Units Selection&#039;,
                    chosen_id_name_hash: JSON.stringify(chosen_id_name_hash),
                    constants    : JSON.stringify(req.C),
                    metadata: metadata_names,  // should contain all the items that selected datasets have
                    user         : req.user
    });  // end render
    // benchmarking
    helpers.elapsed_time(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 4 After Page Render &lt;&lt;&lt;&lt;&lt;&lt;&quot;);

//  });  // end db query   
   
   

   // benchmarking
   helpers.elapsed_time(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; 1 Before Page Render and Query &lt;&lt;&lt;&lt;&lt;&lt;&quot;);


}); // end fxn

/*
 * GET visualization page.
 */
router.get(&#039;/index_visuals&#039;,  function(req, res) {
  // This page is arrived at using GET from the Main Menu
  // It will be protected usind the helpers.isLoggedIn function
  // TESTING:
  //      Should show the closed project list on initialize
  //      The javascript functions (load_project_select, set_check_project, open_datasets, toggle_selected_datasets)
  //        should work to open the project (show and check the datasets) when either the plus image is clicked or the
  //        checkbox is selected. Clicking the minus image should deselect the datasets and close the dataset list.
  //        While the project is open clicking on the project checkbox should toggle all the datasets under it.
  //      Clicking the submit button when no datasets have been selected should result in an alert box and a
  //      return to the page.
  res.render(&#039;visuals/index_visuals&#039;, { 
                                title   : &#039;VAMPS: Select Datasets&#039;,
                                rows    : JSON.stringify(ALL_DATASETS),
                                constants    : JSON.stringify(req.C),
                                user: req.user
                            });
});
//
//
//
router.get(&#039;/reorder_datasets&#039;, function(req, res) {
  console.log(&#039;TODO::TODO reorder datasets&#039;);
  console.log(selection_obj);
  //console.log(chosen_id_name_hash)
});
//
//  C O U N T S  T A B L E
//
router.get(&#039;/user_data/counts_table&#039;, function(req, res) {
  
  var myurl = url.parse(req.url, true);
  var ts   = myurl.query.ts;
  var values_updated = check_initial_status(myurl);  


  var infile = &#039;../../tmp/&#039;+ts+&#039;_count_matrix.biom&#039;;
  fs.readFile(path.resolve(__dirname, infile), &#039;UTF-8&#039;, function (err, file_contents) {
    if (err) {
      console.log(&#039;Could not read file: &#039; + infile + &#039;\nHere is the error: &#039;+ err);
    }
    var mtx = JSON.parse(file_contents);
    if(values_updated) {
      mtx = COMMON.get_custom_biome_matrix(visual_post_items, mtx);
    }
    console.log(&#039;after cust&#039;);
    

    var html = &quot;&lt;table border=&#039;1&#039; class=&#039;single_border center_table&#039;&gt;&lt;tr&gt;&lt;td&gt;&quot;;
    html += COMMON.get_selection_markup(&#039;counts_table&#039;, visual_post_items);     // block for listing prior selections: domains,include_NAs ...
    html += &#039;&lt;/td&gt;&lt;td&gt;&#039;;
    html += COMMON.get_choices_markup(&#039;counts_table&#039;, visual_post_items);       // block for controls to normalize, change tax percentages or distance
    html += &#039;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&#039;;
    html += &quot;&lt;table border=&#039;1&#039; class=&#039;single_border small_font counts_table&#039;&gt;&quot;;
    html += &#039;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&#039;;
    for(var n in mtx.columns){ 
      html += &#039;&lt;td&gt;&#039;+mtx.columns[n].id+&#039;&lt;/td&gt;&#039;;
    }
    html += &#039;&lt;/tr&gt;&#039;;
    for(n in mtx.rows){ 
      html += &#039;&lt;tr&gt;&#039;;
      html += &#039;&lt;td&gt;&#039;+mtx.rows[n].id+&#039;&lt;/td&gt;&#039;;
      for(i in mtx.data[n]) {
        var cnt = mtx.data[n][i];
        var pct =  (cnt * 100 / mtx.column_totals[i]).toFixed(2);
        var id  = mtx.columns[i].id+&#039;-|-&#039;+cnt.toString()+&#039;-|-&#039;+pct.toString();
        html += &quot;&lt;td id=&#039;&quot;+id+&quot;&#039; class=&#039;tooltip right_justify&#039;&gt;&quot;+cnt+&#039;&lt;/td&gt;&#039;;
      }
      html += &#039;&lt;/tr&gt;&#039;;
    }
    html += &#039;&lt;tr&gt;&#039;;
    html += &quot;&lt;td class=&#039;right_justify&#039;&gt;&lt;strong&gt;Sums:&lt;/strong&gt;&lt;/td&gt;&quot;;
    for(n in mtx.column_totals) {
      html += &quot;&lt;td class=&#039;right_justify&#039;&gt;&quot;+mtx.column_totals[n]+&#039;&lt;/td&gt;&#039;;
    } 
    html += &#039;&lt;/tr&gt;&#039;;
    html += &#039;&lt;/table&gt;&#039;;
    res.render(&#039;visuals/user_data/counts_table&#039;, {
      title: req.params.title   || &#039;default_title&#039;,
      timestamp: ts || &#039;default_timestamp&#039;,
      html : html,
      user: req.user
    });
  });
});

//
// B A R C H A R T S
//
router.get(&#039;/user_data/barcharts&#039;, function(req, res) {
  var myurl = url.parse(req.url, true);
  //console.log(myurl)
  var ts = myurl.query.ts;
  var values_updated = check_initial_status(myurl);  
  
  var infile = &#039;../../tmp/&#039;+ts+&#039;_count_matrix.biom&#039;;
  fs.readFile(path.resolve(__dirname, infile), &#039;UTF-8&#039;, function (err, file_contents) {
    if (err) {
      console.log(&#039;Could not read file: &#039; + infile + &#039;\nHere is the error: &#039;+ err);
    }
    var mtx = JSON.parse(file_contents);

    if(values_updated) {
      mtx = COMMON.get_custom_biome_matrix(visual_post_items, mtx);
    }
     
    var html = &#039;&lt;table border=&quot;1&quot; class=&quot;single_border center_table&quot;&gt;&lt;tr&gt;&lt;td&gt;&#039;;
    html += COMMON.get_selection_markup(&#039;barcharts&#039;, visual_post_items); // block for listing prior selections: domains,include_NAs ...
    html += &#039;&lt;/td&gt;&lt;td&gt;&#039;;
    html += COMMON.get_choices_markup(&#039;barcharts&#039;, visual_post_items);      // block for controls to normalize, change tax percentages or distance
    html += &#039;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&#039;;
   

    //var BCHARTS = require(&#039;./routes_bar_charts_states&#039;);
    html += BCHARTS.create_barcharts_html ( ts, res, mtx );

    res.render(&#039;visuals/user_data/barcharts&#039;, {
          //title: req.params.title   || &#039;default_title&#039;,
          timestamp: ts || &#039;default_timestamp&#039;,
          html : html,
          user: req.user
        });

  });
});

//
// P I E C H A R T S
//
router.get(&#039;/user_data/piecharts&#039;, function(req, res) {
  var myurl = url.parse(req.url, true);
  //console.log(myurl)
  var ts = myurl.query.ts;
  var values_updated = check_initial_status(myurl);  
 
  var infile = path.join(__dirname, &#039;../../tmp/&#039;+ts+&#039;_count_matrix.biom&#039;);
  console.log(&#039;in create_piecharts_html: &#039;+infile);

  fs.readFile(infile, &#039;utf8&#039;, function (err, json) {
    var mtx = JSON.parse(json);
    if(values_updated) {
      mtx = COMMON.get_custom_biome_matrix(visual_post_items, mtx);
    }

    var html = &#039;&lt;table border=&quot;1&quot; class=&quot;single_border center_table&quot;&gt;&lt;tr&gt;&lt;td&gt;&#039;;
    html += COMMON.get_selection_markup(&#039;piecharts&#039;, visual_post_items); // block for listing prior selections: domains,include_NAs ...
    html += &#039;&lt;/td&gt;&lt;td&gt;&#039;;
    html += COMMON.get_choices_markup(&#039;piecharts&#039;, visual_post_items);      // block for controls to normalize, change tax percentages or distance
    html += &#039;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&#039;;
   
    html += PCHARTS.create_piecharts_html ( ts, res, mtx );

    res.render(&#039;visuals/user_data/piecharts&#039;, {
          //title: req.params.title   || &#039;default_title&#039;,
          timestamp: ts || &#039;default_timestamp&#039;,
          html : html,
          user: req.user
        });

  });
});
//
// P I E C H A R T  -- S I N G L E
//
router.get(&#039;/user_data/piechart_single&#039;, function(req, res) {
  var myurl = url.parse(req.url, true);
  //console.log(myurl)
  var ts = myurl.query.ts;
  var ds = myurl.query.ds;

  var html = &#039;&lt;table border=&quot;1&quot; class=&quot;single_border center_table&quot;&gt;&lt;tr&gt;&lt;td&gt;&#039;;
    html += COMMON.get_selection_markup(&#039;piecharts&#039;, visual_post_items); // block for listing prior selections: domains,include_NAs ...
    html += &#039;&lt;/td&gt;&lt;td&gt;&#039;;
    html += COMMON.get_choices_markup(&#039;piecharts&#039;, visual_post_items);      // block for controls to normalize, change tax percentages or distance
    html += &#039;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&#039;;
    res.render(&#039;visuals/user_data/piechart_single&#039;, {
          title: &#039;Single PieChart:&#039;,
          subtitle: ds,
          timestamp: ts || &#039;default_timestamp&#039;,
          dataset: ds,
          html: html,
          user: req.user
        });

 
});

//
//   H E A T M A P
//
router.get(&#039;/user_data/heatmap&#039;, function(req, res) {
  var myurl = url.parse(req.url, true);
  
  var ts    = myurl.query.ts;
  var values_updated = check_initial_status(myurl);  
  var biom_file,R_command;
  var infile_name = ts+&#039;_count_matrix.biom&#039;;
  var infile = path.join(__dirname, &#039;../../tmp/&#039;+infile_name);
  var script_file = path.resolve(__dirname, &#039;../../public/scripts/distance.R&#039;);

  if(values_updated) {
    fs.readFile(infile, &#039;utf8&#039;, function (err, json) {
      var mtx = JSON.parse(json);
      COMMON.get_custom_biome_matrix(visual_post_items, mtx);
      biom_file = ts+&#039;_count_matrix_cust_heat.biom&#039;;
      R_command = [req.C.RSCRIPT_CMD, script_file, biom_file, visual_post_items.selected_distance].join(&#039; &#039;);
      console.log(R_command);
      // must write custom file for R script
      COMMON.write_file( &#039;../../tmp/&#039;+biom_file, JSON.stringify(mtx,null,2) );  
      console.log(&#039;Writing/Using custom matrix file&#039;);
      run_R_cmd(req,res,  ts, R_command, &#039;heatmap&#039;);
      
    });
  }else{
    biom_file = infile_name;
    R_command = [req.C.RSCRIPT_CMD, script_file, biom_file, visual_post_items.selected_distance].join(&#039; &#039;);
    console.log(R_command);
    console.log(&#039;Using original matrix file&#039;);
    run_R_cmd(req,res,  ts, R_command, &#039;heatmap&#039;);

  } 
 
});
//
//   D E N D R O G R A M
//
router.get(&#039;/user_data/dendrogram&#039;, function(req, res) {
  var myurl = url.parse(req.url, true);
  
  var ts    = myurl.query.ts;
  var values_updated = check_initial_status(myurl);  
  var biom_file,R_command;
  var infile_name = ts+&#039;_count_matrix.biom&#039;;
  var infile = path.join(__dirname, &#039;../../tmp/&#039;+infile_name);
  var script_file = path.resolve(__dirname, &#039;../../public/scripts/dendrogram.R&#039;);
  if(values_updated) {
    fs.readFile(infile, &#039;utf8&#039;, function (err, json) {
      var mtx = JSON.parse(json);
      COMMON.get_custom_biome_matrix(visual_post_items, mtx);
      biom_file = ts+&#039;_count_matrix_cust_dend.biom&#039;;
      R_command = req.C.RSCRIPT_CMD + &#039; &#039; + script_file + &#039; &#039; + biom_file + &#039; &#039; + visual_post_items.selected_distance;
      console.log(R_command);
      COMMON.write_file( &#039;../../tmp/&#039;+biom_file, JSON.stringify(mtx,null,2) );  
      console.log(&#039;Writing/Using cust matrix file&#039;);
      run_R_cmd(req, res, ts, R_command, &#039;dendrogram&#039;);
    });
  }else {
    biom_file = infile_name;
    R_command = [req.C.RSCRIPT_CMD, script_file, biom_file, visual_post_items.selected_distance].join(&#039; &#039;);
    console.log(R_command);
    console.log(&#039;Using original matrix file&#039;);
    run_R_cmd(req, res, ts, R_command, &#039;dendrogram&#039;);
  } 

});
//
//   P C O A
//
router.get(&#039;/user_data/pcoa&#039;, function(req, res) {
  var myurl = url.parse(req.url, true);
  
  var ts    = myurl.query.ts;
  var values_updated = check_initial_status(myurl);  
  var biom_file,R_command;
  var infile_name = ts+&#039;_count_matrix.biom&#039;;
  var metafile_name = ts+&#039;_metadata.txt&#039;
  var biom_file = path.resolve(__dirname, &#039;../../tmp/&#039;+infile_name);
  var script_file = path.resolve(__dirname, &#039;../../public/scripts/pcoa.R&#039;);
  var metadata_file = path.resolve(__dirname, &#039;../../tmp/&#039;+metafile_name);
  var name_on_graph= &#039;no&#039;;
    
  R_command = [req.C.RSCRIPT_CMD, script_file, biom_file, metadata_file, visual_post_items.selected_distance, name_on_graph].join(&#039; &#039;);
  console.log(R_command);
  console.log(&#039;Using original matrix file&#039;);
  run_R_cmd(req, res, ts, R_command, &#039;pcoa&#039;);
 

});
//
//   F R E Q U E N C Y  H E A T M A P
//
router.get(&#039;/user_data/frequency_heatmap&#039;, function(req, res) {
  var myurl = url.parse(req.url, true);
  
  var ts    = myurl.query.ts;
  var values_updated = check_initial_status(myurl);  
  
 

});
/*
*   PARTIALS
*      These six partials all belong to the unit_selection page
*      and are shown via ajax depending on user selection in combo box
*       on that page.  AAV
*/
router.get(&#039;/partials/tax_silva108_simple&#039;,  function(req, res) {
    res.render(&#039;visuals/partials/tax_silva108_simple&#039;, {
        doms: req.C.DOMAINS
    });
});
//
//
//

// benchmarking
// var start = process.hrtime();
// 
// var elapsed_time = function(note){
//     var precision = 3; // 3 decimal places
//     var elapsed = process.hrtime(start)[1] / 1000000; // divide by a million to get nano to milli
//     console.log(process.hrtime(start)[0] + &quot; s, &quot; + elapsed.toFixed(precision) + &quot; ms - &quot; + note); // print message + time
//     start = process.hrtime(); // reset the timer
// };

router.get(&#039;/partials/tax_silva108_custom&#039;,  function(req, res) {
  res.render(&#039;visuals/partials/tax_silva108_custom&#039;, 
    { title   : &#039;Silva(v108) Custom Taxonomy Selection&#039;});
});

router.get(&#039;/partials/tax_gg_custom&#039;,  function(req, res) {
    res.render(&#039;visuals/partials/tax_gg_custom&#039;,{});
});
router.get(&#039;/partials/tax_gg_simple&#039;,  function(req, res) {
    res.render(&#039;visuals/partials/tax_gg_simple&#039;,{});
});
router.get(&#039;/partials/otus&#039;,  function(req, res) {
    res.render(&#039;visuals/partials/otus&#039;,{});
});
router.get(&#039;/partials/med_nodes&#039;,  function(req, res) {
    res.render(&#039;visuals/partials/med_nodes&#039;,{});
});



module.exports = router;

/**
* F U N C T I O N S
*/

function IsJsonString(str) {
    try {
        JSON.parse(str);
    } catch (e) {
        return false;
    }
    return true;
}
//
//
//
function check_initial_status(url) {

  var values_updated;
  var min,max,norm,dist;
  // these only seen in url after page first rendered
  if(url.query.min_range === undefined) {
    min   = 0;
    max   = 100;
    norm  = &#039;none&#039;;
    dist  = &#039;morisita_horn&#039;;  // default distance    
    values_updated = false;
  } else {
    min   = url.query.min_range  || 0;
    max   = url.query.max_range  || 100;
    norm  = url.query.norm       ||  &#039;none&#039;;
    dist  = url.query.selected_distance || &#039;morisita_horn&#039;;  // default distance    
    values_updated = true;    
  }

  if(Number(max) &lt;= Number(min)) {min=0;max=100;} 
  visual_post_items.min_range = Number(min);
  visual_post_items.max_range = Number(max);
  visual_post_items.normalization = norm;
  visual_post_items.selected_distance = dist;
  
  //console.log(&#039;min &#039;+min.toString()+&#039; max &#039;+max.toString()+&#039; norm &#039;+norm)
  if(Number(min)===0 &amp;&amp; Number(max)===100 &amp;&amp; norm===&#039;none&#039;) {
    values_updated = false;  // return to initial state
  }
  return values_updated;
}

//
//
//
function run_R_cmd(req,res, ts, R_command, visual_name) {
    var exec = require(&#039;child_process&#039;).exec;
    var html = &#039;&lt;table border=&quot;1&quot; class=&quot;single_border center_table&quot;&gt;&lt;tr&gt;&lt;td&gt;&#039;;
    html += COMMON.get_selection_markup(visual_name, visual_post_items); // block for listing prior selections: domains,include_NAs ...
    html += &#039;&lt;/td&gt;&lt;td&gt;&#039;;
    html += COMMON.get_choices_markup(visual_name, visual_post_items);      // block for controls to normalize, change tax percentages or distance
    html += &#039;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&#039;;

    exec(R_command, {maxBuffer:16000*1024}, function (error, stdout, stderr) {  // currently 16000*1024 handles 232 datasets
      if(stderr){console.log(stderr);}
      stdout = stdout.trim();
      console.log(stdout);
      if(stdout === &#039;dist(0)&#039; || stdout === &#039;err&#039; || stdout===&#039;&#039;) {
        html += &#039;&lt;div&gt;Error -- No distances were calculated.&lt;/div&gt;&#039;;
      }else{
        if(visual_name === &#039;heatmap&#039;) {
          var dm = HMAP.create_distance_matrix(stdout);
          html  += HMAP.create_hm_html(dm);  
        }else if(visual_name===&#039;dendrogram&#039;) {
          html += DEND.create_dendrogram_html(stdout, visual_post_items.no_of_datasets);  
        }else if(visual_name===&#039;pcoa&#039;) {
          html += &quot;&lt;a href=&#039;/tmp/vamps_pcoa.pdf&#039;&gt;Show pdf&lt;/a&gt;&quot;;  

        }
        
      }

      res.render(&#039;visuals/user_data/&#039;+visual_name, {
            title: req.params.title   || &#039;default_title&#039;,
            timestamp: ts || &#039;default_timestamp&#039;,
            html : html,
            user: req.user
      });
      

    });
}</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
